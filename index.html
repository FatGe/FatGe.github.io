<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>



  <meta property="og:type" content="website">
<meta property="og:title" content="Yzz的神秘商店💪">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Yzz的神秘商店💪">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Yzz的神秘商店💪">





  
  
  <link rel="canonical" href="http://yoursite.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Yzz的神秘商店💪</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?057612918e8dc059ce1aaf55193ed453";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Yzz的神秘商店💪</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/19/spread-operator-for-objects/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yzz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yzz的神秘商店💪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/19/spread-operator-for-objects/" class="post-title-link" itemprop="url">你要知道的 - Spread Operator for objects 技巧</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-19 18:50:14 / 修改时间：18:57:29" itemprop="dateCreated datePublished" datetime="2019-10-19T18:50:14+08:00">2019-10-19</time>
            </span>
          

          
            

            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>今天看到了<a href="https://juejin.im/post/5c340756e51d45523070f877" target="_blank" rel="noopener">你必须收藏的 ES6 语法密糖 - Spread Operator 技巧</a>，这篇文章，收获很多，同时也想起来<br><code>...</code> 也有一些操作对象的用法，总结了一下。</p>
</blockquote>
<p>在 ECMAScript 2018 中 Spread Operator 增加了对对象的支持，使得它的应用更为广泛，本文重点介绍如何将它与 Object 一起使用以及与 <code>Object.assgin</code> 的区别。</p>
<p>可以通过<a href="https://babeljs.io/repl" target="_blank" rel="noopener">BABEL</a>，查看示例代码 babel 编译后的结果。</p>
<h5 id="解构赋值"><a href="#解构赋值" class="headerlink" title="...  解构赋值"></a><code>...</code>  解构赋值</h5><p>除去已经声明的属性，<strong>剩余</strong>的所有属性都会赋给 <code>...</code> 后的属性名</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; x, ...y &#125; = &#123; <span class="attr">x</span>: <span class="number">1</span>, <span class="attr">y</span>: <span class="number">2</span>, <span class="attr">a</span>: <span class="number">3</span>, <span class="attr">b</span>: <span class="number">4</span> &#125;;</span><br><span class="line"><span class="built_in">console</span>.log(x); <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(y); <span class="comment">// &#123;y: 2, a: 3, b: 4&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="删除属性值"><a href="#删除属性值" class="headerlink" title="... 删除属性值"></a><code>...</code> 删除属性值</h5><p>利用 <code>...</code> 来删除对象中的某一个属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; <span class="attr">x</span>: deleted, ...y &#125; = &#123; <span class="attr">x</span>: <span class="number">1</span>, <span class="attr">y</span>: <span class="number">2</span>, <span class="attr">a</span>: <span class="number">3</span>, <span class="attr">b</span>: <span class="number">4</span> &#125;;</span><br><span class="line"><span class="built_in">console</span>.log(y); <span class="comment">// &#123;y: 2, a: 3, b: 4&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="复制对象"><a href="#复制对象" class="headerlink" title="...  复制对象"></a><code>...</code>  复制对象</h5><p>在 JavaScript 中，有一个常见赋值语法如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cat = &#123; <span class="attr">age</span>: <span class="number">4</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> kitten = cat;</span><br><span class="line">kitten.age = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>此时，  <code>cat</code> 和 <code>kitten</code> 引用同一个对象，如果修改了 <code>kitten</code> 的属性，相应的 <code>cat</code> 也会发生变化。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(kitten.age); <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(cat.age); <span class="comment">// 1 &lt;-- problem!</span></span><br></pre></td></tr></table></figure>

<p>使用 Spread Operator 可以轻松地创建一个具有现有对象的所有相同属性的新对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cat = &#123; <span class="attr">age</span>: <span class="number">4</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> kitten = &#123; ...cat &#125;; <span class="comment">// &lt;-- changed</span></span><br><span class="line">kitten.age = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(kitten.age); <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(cat.age); <span class="comment">// 4 &lt;-- fixed!</span></span><br></pre></td></tr></table></figure>

<p><strong>但是</strong>，利用 Spread Operator 去赋值对象，只能完成<strong>浅复制</strong>，也就是说利用 <code>...</code> 去复制对象时，并不能递归地复制所有层级。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cat = &#123; <span class="attr">age</span>: <span class="number">4</span>, <span class="attr">toys</span>: [<span class="string">"mouse"</span>, <span class="string">"catnip"</span>] &#125;;</span><br><span class="line"><span class="keyword">const</span> kitten = &#123; ...cat &#125;;</span><br><span class="line"><span class="comment">// const kitten = Object.assign(&#123;&#125;, cat); &lt;-- same result</span></span><br><span class="line">kitten.toys[<span class="number">1</span>] = <span class="string">"yarn"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(kitten.toys); <span class="comment">// ["mouse", "yarn"]</span></span><br><span class="line"><span class="built_in">console</span>.log(cat.toys); <span class="comment">// ["mouse", "yarn"] &lt;-- problem!</span></span><br></pre></td></tr></table></figure>

<h5 id="扩展对象"><a href="#扩展对象" class="headerlink" title="...  扩展对象"></a><code>...</code>  扩展对象</h5><p>利用 <code>...</code> 来拓展对象，就是将<strong>新属性</strong>添加到使用 Spread Operator 创建的对象上</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cat = &#123; <span class="attr">legs</span>: <span class="number">4</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> dog = &#123;</span><br><span class="line">    ...cat,</span><br><span class="line">    sound: <span class="string">"woof"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(cat); <span class="comment">// &#123; legs: 4 &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(dog); <span class="comment">// &#123; legs: 4, sound: "woof" &#125;</span></span><br></pre></td></tr></table></figure>

<p>同样，可以看到 <code>cat</code> 对象未被更改，但新 <code>dog</code> 对象具有来自 <code>cat</code> 的 <code>legs</code> 属性以及新  <code>sound</code> 属性，如果<code>sound</code> 已经存在的话，则会覆盖。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cat = &#123; <span class="attr">legs</span>: <span class="number">4</span>, <span class="attr">sound</span>: <span class="string">"meow"</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> dog = &#123;</span><br><span class="line">    ...cat,</span><br><span class="line">    sound: <span class="string">"woof"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(cat); <span class="comment">// &#123; legs: 4, sound: "meow" &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(dog); <span class="comment">// &#123; legs: 4, sound: "woof" &#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>但是</strong>，使用 <code>...</code> 拓展对象时，要注意<strong>行顺序</strong>，也就是</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cat = &#123; <span class="attr">legs</span>: <span class="number">4</span>, <span class="attr">sound</span>: <span class="string">"meow"</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> dog = &#123;</span><br><span class="line">    sound: <span class="string">"woof"</span>,</span><br><span class="line">    ...cat</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(cat); <span class="comment">// &#123; legs: 4, sound: "meow" &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(dog); <span class="comment">// &#123; legs: 4, sound: "meow" &#125;</span></span><br></pre></td></tr></table></figure>

<p>上述 <code>...cat</code> 将 <code>sound: &quot;woof&quot;</code> 改写为 <code>sound: &quot;meow&quot;</code>。</p>
<h5 id="与-Object-assign-的区别"><a href="#与-Object-assign-的区别" class="headerlink" title="... 与 Object.assign 的区别"></a><code>...</code> 与 <code>Object.assign</code> 的区别</h5><p>在上述利用 <code>...</code> 处理对象的过程中，会发现 <code>...</code> 有些时候与 <code>Object.assgin</code> 的操作近乎与等价的，那么他们具体的区别是什么。</p>
<p><code>...</code> 和 <code>Object.assign()</code> 整体的用法非常下关系，主要区别在于 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign" target="_blank" rel="noopener"><code>Object.assign()</code></a> 函数会触发 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/set" target="_blank" rel="noopener">setters</a>，而 <code>...</code> 语法则不会，也就是说 <code>...</code> 是定义了新属性，而 <code>Object.assign()</code> 则是设置了它们。</p>
<h4 id="Object-assign-的基本用法"><a href="#Object-assign-的基本用法" class="headerlink" title="Object.assign() 的基本用法"></a><code>Object.assign()</code> 的基本用法</h4><ul>
<li><p>改变原有对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.assign(target, source1, source2);</span><br></pre></td></tr></table></figure>

<p><code>target</code> 已经被修改，<code>source1</code> 以及 <code>source2</code> 会被复制到其中。</p>
</li>
<li><p>创建新的对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="built_in">Object</span>.assign(&#123;&#125;, source1, source2);</span><br></pre></td></tr></table></figure>

<p><code>result</code> 是一个新的对象，<code>source1</code> 以及 <code>source2</code> 被复制到其中。</p>
</li>
</ul>
<p>在第二种方法上，<code>...</code> 与 <code>Object.assign()</code> 是非常类似的。接下来，阐述它们之间具体的相似点和不同点。</p>
<h4 id="Object-assign-与-的相同点"><a href="#Object-assign-与-的相同点" class="headerlink" title="Object.assign 与 ... 的相同点"></a><code>Object.assign</code> 与 <code>...</code> 的相同点</h4><ul>
<li><p><code>...</code> 和 <code>Object.assign()</code> 都是通过 <code>get</code> 运算符来取值</p>
<p>在将它们写入目标之前，这两个操作都会使用 <code>get</code> 操作从源对象读取相应的属性值。因此，在此过程中，<code>getter</code> 将转换为正常的数据属性，具体如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> original = &#123;</span><br><span class="line">    <span class="keyword">get</span> foo() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'getter'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">123</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>original</code> 对象有 <code>getter foo</code>，而 <code>setter</code> 为 <code>undeined</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.getOwnPropertyDescriptor(original, <span class="string">'foo'</span>)</span><br><span class="line"><span class="comment">/* log</span></span><br><span class="line"><span class="comment">&#123; </span></span><br><span class="line"><span class="comment">    get: [Function: foo],</span></span><br><span class="line"><span class="comment">  	set: undefined,</span></span><br><span class="line"><span class="comment">  	enumerable: true,</span></span><br><span class="line"><span class="comment">  	configurable: true </span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>但是，利用 <code>Object.assgin()</code> 以及 <code>...</code> 对 <code>original</code> 对象进行克隆时，会发现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> clone1 = &#123;...original&#125;;</span><br><span class="line"><span class="comment">// 触发 original 的 getter 会 log "getter"</span></span><br><span class="line"><span class="built_in">Object</span>.getOwnPropertyDescriptor(clone1, <span class="string">'foo'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* log getter 以及被转换为正常的数据属性</span></span><br><span class="line"><span class="comment">&#123; </span></span><br><span class="line"><span class="comment">	value: 123,</span></span><br><span class="line"><span class="comment">  	writable: true,</span></span><br><span class="line"><span class="comment">  	enumerable: true,</span></span><br><span class="line"><span class="comment">  	configurable: true </span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clone2 = <span class="built_in">Object</span>.assign(&#123;&#125;, original);</span><br><span class="line"><span class="comment">// 触发 original 的 getter 会 log "getter"</span></span><br><span class="line"><span class="built_in">Object</span>.getOwnPropertyDescriptor(clone2, <span class="string">'foo'</span>)</span><br><span class="line">&#123; </span><br><span class="line">	value: <span class="number">123</span>,</span><br><span class="line">  	writable: <span class="literal">true</span>,</span><br><span class="line">  	enumerable: <span class="literal">true</span>,</span><br><span class="line">  	configurable: <span class="literal">true</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述结果表明，在得到的 <code>clone1</code> 和 <code>clone2</code>中，<code>foo</code> 只是一个普通的数据属性（它的属性描述符具有属性值和可写）；</p>
</li>
<li><p><code>...</code> 和 <code>Object.assign</code> 只会处理可枚举数据</p>
<p>这两个操作都会忽略所有继承的属性和所有不可枚举的属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> proto = &#123;</span><br><span class="line">    inheritedEnumerable: <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> obj = <span class="built_in">Object</span>.create(proto, &#123;</span><br><span class="line">    ownEnumerable: &#123;</span><br><span class="line">        value: <span class="number">2</span>,</span><br><span class="line">        enumerable: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    ownNonEnumerable: &#123;</span><br><span class="line">        value: <span class="number">3</span>,</span><br><span class="line">        enumerable: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(obj);</span><br><span class="line"><span class="comment">// &#123; ownEnumerable: 2, ownNonEnumerable: 3, __proto__: &#123; inheritedEnumerable: 1 &#125; &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(&#123; ...obj &#125;);</span><br><span class="line"><span class="comment">// &#123; ownEnumerable: 2 &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.assign(&#123;&#125;, obj));</span><br><span class="line"><span class="comment">// &#123; ownEnumerable: 2 &#125;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Object-assign-与-的不同点"><a href="#Object-assign-与-的不同点" class="headerlink" title="Object.assign 与 ... 的不同点"></a><code>Object.assign</code> 与 <code>...</code> 的不同点</h4><p>  它们的不同点在于 <code>...</code> 会定义属性，而 <code>Object.assign()</code>  会设置它们，也就是说 <code>...</code> 定义了目标对象中的新属性，<code>Object.assign()</code> 则是使用 <code>set</code> 操作符进行写入。</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.defineProperty(<span class="built_in">Object</span>.prototype, <span class="string">'foo'</span>, &#123;</span><br><span class="line">    <span class="keyword">set</span>(value) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'SET'</span>, value);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">foo</span>: <span class="number">123</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.assign(&#123;&#125;, obj));</span><br><span class="line"><span class="comment">// 会触发 set, log SET 123</span></span><br><span class="line"><span class="comment">// log &#123;&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(&#123; ...obj &#125;);</span><br><span class="line"><span class="comment">// log &#123; foo: 123 &#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="https://juejin.im/post/5c340756e51d45523070f877" target="_blank" rel="noopener">https://juejin.im/post/5c340756e51d45523070f877</a></li>
<li><a href="https://lucybain.com/blog/2018/js-es6-spread-operator/" target="_blank" rel="noopener">https://lucybain.com/blog/2018/js-es6-spread-operator/</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Spread_syntax" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Spread_syntax</a></li>
<li><a href="http://2ality.com/2016/10/rest-spread-properties.html" target="_blank" rel="noopener">http://2ality.com/2016/10/rest-spread-properties.html</a></li>
</ul>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/19/ts-in-rollup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yzz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yzz的神秘商店💪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/19/ts-in-rollup/" class="post-title-link" itemprop="url">利用 gulp 解决 rollup 中 typescript 与 babel 冲突</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-19 18:42:01 / 修改时间：18:48:50" itemprop="dateCreated datePublished" datetime="2019-10-19T18:42:01+08:00">2019-10-19</time>
            </span>
          

          
            

            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/工具/" itemprop="url" rel="index"><span itemprop="name">工具</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近在用 lerna 重构一个项目，其中一个 package 是使用 rollup 作为脚手架的，需要使用 ts 对其进行重写，但是发现在使用 rollup 时，ts 只能被编译为 js，而之后却不能用 babel 编译为 es3.</p>
</blockquote>
<p>首先明确 rollup 需要处理的任务流为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">typescript = (rollup-plugin-typescript2) </span><br><span class="line">    	   =&gt; ES5 = (babel) </span><br><span class="line">           =&gt; ES3</span><br></pre></td></tr></table></figure>

<p>但是第一步、二步冲突，故采用 gulp 将上述任务拆分。</p>
<h2 id="项目搭建"><a href="#项目搭建" class="headerlink" title="项目搭建"></a>项目搭建</h2><p>首先创建 rollup-repo 项目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir rollup-repo &amp;&amp; <span class="built_in">cd</span> <span class="variable">$_</span></span><br></pre></td></tr></table></figure>

<p>安装 gulp 两个工具在项目内</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化项目</span></span><br><span class="line">npm init</span><br><span class="line"><span class="comment"># 安装 gulp</span></span><br><span class="line">npm install --save-dev gulp</span><br></pre></td></tr></table></figure>

<p>然后创建 gulpfile.js 脚本用于后续运行，并在文件中输入以下代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> gulp = <span class="built_in">require</span> (<span class="string">'gulp'</span>);</span><br><span class="line"></span><br><span class="line">gulp.task (<span class="string">'build'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log (<span class="string">'build'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>同时在 package.json 中添加 <code>script</code>，并在终端中输入 <code>npm run build</code>，看是否打印出 <code>build</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">    "build": "gulp build",</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="引入-rollup"><a href="#引入-rollup" class="headerlink" title="引入 rollup"></a>引入 rollup</h2><p>在项目中安装 rollup 用于打包 typescript</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 rollup</span></span><br><span class="line">npm install --save-dev rollup</span><br></pre></td></tr></table></figure>

<p>首先解决之前的第一个问题 typescript 转 ES2015</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rollup-plugin-tslint 用于检测 typescript</span></span><br><span class="line">npm install --save-dev rollup-plugin-tslint</span><br><span class="line"><span class="comment"># rollup-plugin-typescript2 用于将 ts 编译为 js</span></span><br><span class="line">npm install --save-dev rollup-plugin-typescript2</span><br></pre></td></tr></table></figure>

<p>将 rollup 处理 typescript 作为 gulp 的一个 task，使用 ./temp/index.js 作为中转的文件。更新 gulpfile.js 的内容如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;task, src, dest&#125; = <span class="built_in">require</span> (<span class="string">'gulp'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;rollup&#125; = <span class="built_in">require</span> (<span class="string">'rollup'</span>);</span><br><span class="line"><span class="keyword">const</span> tslint = <span class="built_in">require</span> (<span class="string">'rollup-plugin-tslint'</span>);</span><br><span class="line"><span class="keyword">const</span> typescript = <span class="built_in">require</span> (<span class="string">'rollup-plugin-typescript2'</span>);</span><br><span class="line"><span class="keyword">const</span> tempFile = <span class="string">'./temp.js'</span>;</span><br><span class="line"></span><br><span class="line">task (<span class="string">'build'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> bundleJS = <span class="keyword">await</span> rollup (&#123;</span><br><span class="line">    input: <span class="string">'index.ts'</span>,</span><br><span class="line">    plugins: [tslint (), typescript ()],</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> bundleJS.write (&#123;</span><br><span class="line">    file: tempFile,</span><br><span class="line">    format: <span class="string">'cjs'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在终端中运行命令 <code>npm run build</code>，此时发现在 tempFile 中，typescript 已经被编译为 ES2015 的代码，之后需要我们将它转换为 ES3</p>
<p>引入 gulp-babel 来处理这个任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev gulp-babel</span><br></pre></td></tr></table></figure>

<p>之后就是 gulp 很明显的 pipe 方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;task, src, dest&#125; = <span class="built_in">require</span> (<span class="string">'gulp'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;rollup&#125; = <span class="built_in">require</span> (<span class="string">'rollup'</span>);</span><br><span class="line"><span class="keyword">const</span> tslint = <span class="built_in">require</span> (<span class="string">'rollup-plugin-tslint'</span>);</span><br><span class="line"><span class="keyword">const</span> typescript = <span class="built_in">require</span> (<span class="string">'rollup-plugin-typescript2'</span>);</span><br><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span> (<span class="string">'gulp-babel'</span>);</span><br><span class="line"><span class="keyword">const</span> tempFile = <span class="string">'./temp.js'</span>;</span><br><span class="line"></span><br><span class="line">task (<span class="string">'build'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> bundleJS = <span class="keyword">await</span> rollup (&#123;</span><br><span class="line">    input: <span class="string">'index.ts'</span>,</span><br><span class="line">    plugins: [tslint (), typescript ()],</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> bundleJS.write (&#123;</span><br><span class="line">    file: tempFile,</span><br><span class="line">    format: <span class="string">'cjs'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  src (tempFile)</span><br><span class="line">    .pipe (</span><br><span class="line">      babel (&#123;</span><br><span class="line">        presets: [<span class="string">'@babel/env'</span>],</span><br><span class="line">      &#125;)</span><br><span class="line">    )</span><br><span class="line">    .pipe (dest (<span class="string">'dist'</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>利用 <code>babel</code> 将 temp.js 中 ES2015 的代码编译为 ES3</p>
<p>至此，任务已经初步完成了，后续需要我们将 temp.js 删除并 uglyfly 代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clean file</span></span><br><span class="line">npm install --save-dev gulp-clean</span><br><span class="line"><span class="comment"># uglyfly file</span></span><br><span class="line">npm install --save-dev gulp-uglyfly</span><br></pre></td></tr></table></figure>

<p>引入两个插件来完成细化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">src (tempFile)</span><br><span class="line">    .pipe (</span><br><span class="line">      babel (&#123;</span><br><span class="line">        presets: [<span class="string">'@babel/env'</span>],</span><br><span class="line">      &#125;)</span><br><span class="line">    )</span><br><span class="line">    .pipe (clean ())</span><br><span class="line">    .pipe (uglyfly ())</span><br><span class="line">    .pipe (dest (<span class="string">'dist'</span>));</span><br></pre></td></tr></table></figure>

<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>在这个脚手架的配置中主要是想利用 rollup 强大的 tree-shaking 功能，故将其结合在其中，可能会有更好的方法。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/10/link/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yzz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yzz的神秘商店💪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/10/link/" class="post-title-link" itemprop="url">几则 Link 标签冷知识</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-10 18:33:23" itemprop="dateCreated datePublished" datetime="2019-10-10T18:33:23+08:00">2019-10-10</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-10-19 18:56:29" itemprop="dateModified" datetime="2019-10-19T18:56:29+08:00">2019-10-19</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="lt-link-gt-只能在-lt-head-gt-中插入么？"><a href="#lt-link-gt-只能在-lt-head-gt-中插入么？" class="headerlink" title="&lt;link /&gt; 只能在 &lt;head /&gt; 中插入么？"></a><code>&lt;link /&gt;</code> 只能在 <code>&lt;head /&gt;</code> 中插入么？</h2><p>不是。在某些情况下 <code>&lt;link /&gt;</code> 也能插入到 <code>&lt;body /&gt;</code> 中，具体情况取决于当前 <code>&lt;link /&gt;</code> 是否有一个 <strong>body-ok</strong> 的链接类型。例如，在日常开发中，会使用 </p>
<ul>
<li><code>&lt;link rel=&quot;stylesheet&quot; href=&quot;main.css&quot; /&gt;</code> 来链接<strong>样式表</strong>；</li>
<li><code>&lt;link rel=&quot;icon&quot; href=&quot;favicon.ico&quot; /&gt;</code> 来链接<strong>网站的图标</strong>。</li>
</ul>
<p>但是只有 <strong>stylesheet</strong> 类型才是 <strong>body-ok</strong> 可以插入到 <code>&lt;body /&gt;</code> 中，其他类型见 <a href="https://html.spec.whatwg.org/multipage/links.html#body-ok" target="_blank" rel="noopener">HTML Standard</a>。</p>
<p><del>我们可以这么使用</del>（极其不推荐）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// index.html</span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"./styles/head.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- demo 1 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"./styles/body.css"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h5</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>Hello world<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 此时 body.css 会覆盖 .head.css --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是这不是一种好的可遵循的实践方式；更合理的方式是，将你的 <code>&lt;link&gt;</code> 元素从你的 body 内容中分离出来，将其放在 <code>&lt;head&gt;</code> 中。</p>
<h2 id="lt-link-gt-标签的-media-属性"><a href="#lt-link-gt-标签的-media-属性" class="headerlink" title="&lt;link /&gt; 标签的 media 属性"></a><code>&lt;link /&gt;</code> 标签的 <code>media</code> 属性</h2><p>在日常开发中，有时候会碰到需要媒体查询的情况，例如</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// screen width 从 600px 到 900px 时，样式生效  </span><br><span class="line">@<span class="keyword">media</span> screen and (max-width: <span class="number">900px</span>) &#123;</span><br><span class="line">    <span class="selector-class">.title</span> &#123;</span><br><span class="line">        <span class="attribute">color</span>: red;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// screen width 从 0 到 600px 时，样式生效  </span><br><span class="line">@<span class="keyword">media</span> screen and (max-width: <span class="number">600px</span>) &#123;</span><br><span class="line">    <span class="selector-class">.title</span> &#123;</span><br><span class="line">        <span class="attribute">color</span>: green;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>业务不复杂的情况，可以选择这样实现，但是当样式很多时，会造成当前样式表复杂且不不清晰。我们可以借助 <code>&lt;link rel=&quot;stylesheet&quot; media=&quot;(max-width: 600px)&quot; href=&quot;example.css&quot; /&gt;</code> 来分离样式，这个属性规定了外部资源适用的媒体类型。</p>
<h2 id="lt-link-gt-的-disabled-属性"><a href="#lt-link-gt-的-disabled-属性" class="headerlink" title="&lt;link /&gt; 的 disabled 属性"></a><code>&lt;link /&gt;</code> 的 <code>disabled</code> 属性</h2><p>常用于启用或禁用样式表，例如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">'link[href="red.css"]'</span>).disabled = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>可以使得 <code>red.css</code> 失效，一般可以配合 <code>&lt;link /&gt;</code> 的 <code>title</code>、<code>rel</code> 来实现网站换肤功能，具体见</p>
<blockquote>
<p>利用 disabled 实现网站换肤 <a href="https://www.zhangxinxu.com/wordpress/2019/02/link-rel-alternate-website-skin/" target="_blank" rel="noopener">link rel=alternate网站换肤功能最佳实现</a>.</p>
</blockquote>
<h2 id="利用-lt-link-gt-标签完成游览器预加载机制"><a href="#利用-lt-link-gt-标签完成游览器预加载机制" class="headerlink" title="利用 &lt;link /&gt; 标签完成游览器预加载机制"></a>利用 <code>&lt;link /&gt;</code> 标签完成游览器预加载机制</h2><p>在优化页面的首屏的时候，首先要做的就是<strong>限制首次请求的资源大小以及资源数</strong>，但是这样会使得每次跳转至一个未缓存资源的页面时，都需要重新加载。如果在页面加载时候可以满足</p>
<ul>
<li>首屏需要的资源作为即刻资源，希望在页面加载的早期就开始获取，在浏览器的主渲染机制介入前就进行预加载；</li>
<li>当首屏加载完成之后，在加载其他页面的资源，这样既不占有首屏的时间，也可以优化其他页面。</li>
</ul>
<p><code>&lt;link /&gt;</code> 标签的 <code>rel</code> 的属性值 <code>preload</code> 就可以实现这一功能，来指明哪些资源是在页面加载完成后即刻需要的。为了完成基本的配置，你还需要通过 <code>href</code>和<code>as</code> 属性指定需要被预加载资源的资源路径及其类型，具体实例</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"preload"</span> <span class="attr">href</span>=<span class="string">"style.css"</span> <span class="attr">as</span>=<span class="string">"style"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"preload"</span> <span class="attr">href</span>=<span class="string">"main.js"</span> <span class="attr">as</span>=<span class="string">"script"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"style.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h5</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>Hello world<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- hello world 代码片段 * 2048 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"main.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在使用预加载时候，waterfall 如下</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/30/16d817a804296738?w=591&h=170&f=png&s=22354" alt></p>
<p>在不使用预加载的时候</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/30/16d817ae8930811d?w=655&h=177&f=png&s=23083" alt></p>
<p>从图中很明显可以看出 main.js 的加载实际又很明显的分别，也就是预加载的好处。也就实现了，我们对首屏资    源的预加载，而其他资源的加载时机，我们可以通过脚本化来控制，通过新建 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLLinkElement" target="_blank" rel="noopener"><code>HTMLLinkElement</code></a> 元素来实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当首页完成的时候</span></span><br><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 完成对其他资源的预加载</span></span><br><span class="line">	<span class="keyword">var</span> preloadLink = <span class="built_in">document</span>.createElement(<span class="string">"link"</span>);</span><br><span class="line">  preloadLink.href = <span class="string">"myscript.js"</span>;</span><br><span class="line">  preloadLink.rel = <span class="string">"preload"</span>;</span><br><span class="line">  preloadLink.as = <span class="string">"script"</span>;</span><br><span class="line">  <span class="built_in">document</span>.head.appendChild(preloadLink);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="lt-link-gt-的-onload-事件"><a href="#lt-link-gt-的-onload-事件" class="headerlink" title="&lt;link /&gt; 的 onload 事件"></a><code>&lt;link /&gt;</code> 的 onload 事件</h2><p>与 <code>window.onload</code> 事件一样，它赋予了我们监听样式表加载完成的（但是还未应用到内容），也可以通过 error 来监听是否在加载期间发生了异常。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">sheetLoaded</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// Do something interesting; the sheet has been loaded</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">sheetError</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">  alert(<span class="string">"An error occurred loading the stylesheet!"</span>);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"mystylesheet.css"</span> <span class="attr">onload</span>=<span class="string">"sheetLoaded()"</span> <span class="attr">onerror</span>=<span class="string">"sheetError()"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>参考来源</p>
<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Preloading_content" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/HTML/Preloading_content</a></li>
<li><a href="https://www.zhangxinxu.com/wordpress/2019/02/link-rel-alternate-website-skin/" target="_blank" rel="noopener">https://www.zhangxinxu.com/wordpress/2019/02/link-rel-alternate-website-skin/</a></li>
</ul>
</li>
</ul>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/23/react-sortable-hoc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yzz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yzz的神秘商店💪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/23/react-sortable-hoc/" class="post-title-link" itemprop="url">React-sortable-hoc 结合 hook 实现 Draggin 和 Droppin</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-23 09:40:14 / 修改时间：10:01:29" itemprop="dateCreated datePublished" datetime="2019-08-23T09:40:14+08:00">2019-08-23</time>
            </span>
          

          
            

            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>翻译：<a href="https://css-tricks.com/draggin-and-droppin-in-react/" target="_blank" rel="noopener">https://css-tricks.com/draggin-and-droppin-in-react/</a></p>
</blockquote>
<p>React 社区提供了许多的库来实现拖放的功能，例如 <a href="https://github.com/react-dnd/react-dnd" target="_blank" rel="noopener">react-dnd</a>, <a href="https://github.com/atlassian/react-beautiful-dnd" target="_blank" rel="noopener">react-beautiful-dnd</a>, <a href="https://www.npmjs.com/package/react-drag-and-drop" target="_blank" rel="noopener">react-drag-n-drop</a>，等等。但是它们有一些共同的缺陷：</p>
<ul>
<li>使用复杂，有时候需要做很多工作才能构建一个简单的拖放演示；</li>
<li>功能有限，例如无法实现多个拖放实例这样复杂的功能，如果有的话，它也会变得非常复杂。</li>
</ul>
<p>为了解决这些问题，<a href="https://github.com/clauderic/react-sortable-hoc" target="_blank" rel="noopener">react-sortable-hoc</a> 应运而生。</p>
<blockquote>
<p>这篇教程需要你提前了解一些 React 组件以及 hooks 的基础知识。</p>
</blockquote>
<p>React 官方推荐的封装高阶组件的方式是 HOC，我们需要借助它来实现一个具有拖放功能的高阶组件。</p>
<blockquote>
<p>HOC 自身不是 React API 的一部分，它是一种基于 React 的组合特性而形成的设计模式。</p>
</blockquote>
<h2 id="启动项目"><a href="#启动项目" class="headerlink" title="启动项目"></a>启动项目</h2><p>教程最终的目的是构建一个带有趣GIF的应用程序（来自Chris Gannon！），可以在视口周围拖动。具体见</p>
<p><img src="http://fatge.xyz/static/img/drag-example-1.gif" alt></p>
<p>首先，我们利用 create-react-app 来启动一个新的 React 项目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app your-project-name</span><br></pre></td></tr></table></figure>

<p>之后在项目中安装 react-sorting-hoc 以及 array-move，后者是用来实现数组移动。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> your-project-name</span><br><span class="line">yarn add react-sortable-hoc array-move</span><br></pre></td></tr></table></figure>

<h2 id="创建-GIF-组件，添加样式和数据"><a href="#创建-GIF-组件，添加样式和数据" class="headerlink" title="创建 GIF 组件，添加样式和数据"></a>创建 GIF 组件，添加样式和数据</h2><p>为简单起见，我们将在 App.css 文件中编写所有样式。你可以使用以下内容对既有样式进行覆盖：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.App</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#1a1919</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">  <span class="attribute">min-height</span>: <span class="number">100vh</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">25px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.App</span> <span class="selector-tag">h1</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">52px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.App</span> <span class="selector-tag">h2</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#f6c945</span>;</span><br><span class="line">  <span class="attribute">text-transform</span>: uppercase;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.App</span> <span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">cursor</span>: grab;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">180px</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">240px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，让我们使用 React 的 useState hook 来实现 GIF 组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br></pre></td></tr></table></figure>

<p>在src目录中创建一个 Gif.js 文件并写入以下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Gif = <span class="function">(<span class="params">&#123; gif &#125;</span>) =&gt;</span> (<span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;gif&#125;</span> <span class="attr">alt</span>=<span class="string">"gif"</span> /&gt;</span>)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">Gif.propTypes = &#123;</span></span><br><span class="line"><span class="xml">  gif: PropTypes.string.isRequired,</span></span><br><span class="line"><span class="xml">&#125;;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">export default Gif;</span></span><br></pre></td></tr></table></figure>

<p>编写代码时尽力遵循最佳实践，因此我们还导入 PropTypes 进行类型检查。之后将Gif 组件并将其添加到 App 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./App.css'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Gif <span class="keyword">from</span> <span class="string">'./Gif'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [gifs, setGifs] = useState([<span class="string">'https://media.giphy.com/media/3ohhwoWSCtJzznXbuo/giphy.gif'</span>,<span class="string">'https://media.giphy.com/media/l46CbZ7KWEhN1oci4/giphy.gif'</span>,<span class="string">'https://media.giphy.com/media/3ohzgD1wRxpvpkDCSI/giphy.gif'</span>,<span class="string">'https://media.giphy.com/media/xT1XGYy9NPhWRPp4pq/giphy.gif'</span>,]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;h1&gt;Drag those GIFs around&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;h2&gt;Set 1&lt;/</span>h2&gt;</span><br><span class="line">        &#123;gifs.map(<span class="function">(<span class="params">gif,  i</span>) =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Gif</span> <span class="attr">key</span>=<span class="string">&#123;gif&#125;</span> <span class="attr">gif</span>=<span class="string">&#123;gif&#125;</span> /&gt;</span>)&#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<p>运行 <code>npm run start</code>，访问 <a href="http://localhost:3000/，可以看到如下结果" target="_blank" rel="noopener">http://localhost:3000/，可以看到如下结果</a></p>
<p><img src="http://fatge.xyz/static/img/drag-example-2.webp" alt></p>
<h2 id="添加拖放功能"><a href="#添加拖放功能" class="headerlink" title="添加拖放功能"></a>添加拖放功能</h2><p>现在让我们对 Gif 组件添加拖拽功能。首先，我们需要了解 react-sortable-hoc 的两个 HOC，以及 array-move 的 <code>arrayMove</code> 方法，以便于在拖动发生修改数组。首先引入对应组件以及方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; sortableContainer, sortableElement &#125; <span class="keyword">from</span> <span class="string">'react-sortable-hoc'</span>;</span><br><span class="line"><span class="keyword">import</span> arrayMove <span class="keyword">from</span> <span class="string">'array-move'</span>;</span><br></pre></td></tr></table></figure>

<p>之前提到过 HOC，本质上<strong>高阶组件是参数为组件，返回值为新组件的函数。</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EnhancedComponent = higherOrderComponent(WrappedComponent);</span><br></pre></td></tr></table></figure>

<p>可以看出，HOC 就是在当前 component 的外层包裹我们所需要实现的功能。所以 <code>sortableContainer</code>，<code>sortableElement</code> 就是 <code>higherOrderComponent</code>。</p>
<ul>
<li><code>sortableContainer</code> 是所有可排序元素的容器；</li>
<li><code>sortableElement</code>  是每个可渲染元素的容器。</li>
</ul>
<p>import 之后我们要做的是</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SortableGifsContainer = sortableContainer(<span class="function">(<span class="params">&#123; children &#125;</span>) =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"gifs"</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SortableGif = sortableElement(<span class="function">(<span class="params">&#123; gif &#125;</span>) =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Gif</span> <span class="attr">key</span>=<span class="string">&#123;gif&#125;</span> <span class="attr">gif</span>=<span class="string">&#123;gif&#125;</span> /&gt;</span>);</span></span><br></pre></td></tr></table></figure>

<p> <code>SortableGif</code> 为每个子元素创建了一个容器，也就是为单个 Gif 组件创建。它们将使用在 <code>SortableGifsContainer</code> 中，以 <code>children</code> 属性传递进去</p>
<blockquote>
<p>注：您需要将每个子项在 div 或任何其他有效的 HTML 元素中。</p>
</blockquote>
<p>然后用新创建的 <code>SortableGif</code> 替换原有的 <code>Gif</code> 组件，并在 <code>SortableGifsContainer</code> 中使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;SortableGifsContainer axis=<span class="string">"x"</span> onSortEnd=&#123;onSortEnd&#125;&gt;</span><br><span class="line">  &#123;gifs.map(<span class="function">(<span class="params">gif, i</span>) =&gt;</span></span><br><span class="line">    &lt;SortableGif</span><br><span class="line">    <span class="comment">// don't forget to pass index prop with item index</span></span><br><span class="line">      index=&#123;i&#125;</span><br><span class="line">      key=&#123;gif&#125;</span><br><span class="line">      gif=&#123;gif&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  )&#125;</span><br><span class="line">&lt;<span class="regexp">/SortableGifsContainer&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>请务必注意，您需要将 index prop传递给可排序元素，以便库可以区分每一个子项目。它类似于在 React 中向列表添加键。</p>
</blockquote>
<p>在 <code>SortableGifsContainer</code> 上，我们添加了 <code>axis=&quot;x&quot;</code>，是因为 Gif 组件是水平放置的，如果想要水平拖动它们就需要配置 <code>axis</code>，而默认是垂直拖动。换句话说， <code>axis=&quot;x&quot;</code> 限制子项目只能沿水平 x 轴拖放。同时，还添加了 <code>onSortEnd={onSortEnd}</code>，该函数在每次拖动或排序项目时触发。它的实现如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> onSortEnd = <span class="function">(<span class="params">&#123; oldIndex, newIndex &#125;</span>) =&gt;</span> setGifs(arrayMove(gifs, oldIndex, newIndex));</span><br></pre></td></tr></table></figure>

<p><code>onSortEnd</code> 接收了一个被拖动的项目的新旧 <code>index</code>，当然，每次我们移动项目后，我们都会在arrayMove的帮助下修改数据。</p>
<p>现在已经知道如何在项目中实现拖放！ 🎉🎉🎉</p>
<h2 id="如果我们有多个项目列表怎么办？"><a href="#如果我们有多个项目列表怎么办？" class="headerlink" title="如果我们有多个项目列表怎么办？"></a>如果我们有多个项目列表怎么办？</h2><p>之前的例子是为了展示 <code>react-sortable-hoc</code> 的功能，所以非常的清晰以及简单。但是在实际的业务中，你可能会遇到多个项目列表都需要拖放的场景，那该怎么办？</p>
<p>react-sortable-hoc 为我们提供了一个 <code>collection</code> prop  用来区分列表。在上一个例子的基础上，我们添加一个新的列表</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [newGifs, setNewGifs] = useState([</span><br><span class="line">  <span class="string">'https://media.giphy.com/media/xiOgHgY2ceKhm46cAj/giphy.gif'</span>,</span><br><span class="line">  <span class="string">'https://media.giphy.com/media/3oKIPuMqYfRsyJTWfu/giphy.gif'</span>,</span><br><span class="line">  <span class="string">'https://media.giphy.com/media/4ZgLPakqTajjVFOVqw/giphy.gif'</span>,</span><br><span class="line">  <span class="string">'https://media.giphy.com/media/3o7btXIelzs8nBnznG/giphy.gif'</span>,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>和之前一样，除了需要在 <code>SortableGif</code> 组件上添加 <code>collection</code> props 具体如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2&gt;<span class="built_in">Set</span> <span class="number">2</span>&lt;<span class="regexp">/h2&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;SortableGifsContainer axis="x" onSortEnd=&#123;onSortEnd&#125;&gt;</span></span><br><span class="line"><span class="regexp">    &#123;newGifs.map((gif, i) =&gt; (</span></span><br><span class="line"><span class="regexp">        &lt;SortableGif</span></span><br><span class="line"><span class="regexp">            index=&#123;i&#125;</span></span><br><span class="line"><span class="regexp">            key=&#123;gif&#125;</span></span><br><span class="line"><span class="regexp">            gif=&#123;gif&#125;</span></span><br><span class="line"><span class="regexp">            collection="newGifs"</span></span><br><span class="line"><span class="regexp">		/</span>&gt;</span><br><span class="line">    ))&#125;</span><br><span class="line">&lt;<span class="regexp">/SortableGifsContainer&gt;</span></span><br></pre></td></tr></table></figure>

<p>在之前的第一个列表中也添加相应的 <code>collection</code> 属性，例如 <code>collection=&quot;gifs&quot;</code></p>
<p>之后修改 <code>onSortEnd</code> 函数，它的参数中会多一个 <code>collection</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> onSortEnd = <span class="function">(<span class="params">&#123; oldIndex, newIndex, collection &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span>(collection) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'gifs'</span>:</span><br><span class="line">      setGifs(arrayMove(gifs, oldIndex, newIndex))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'newGifs'</span>:</span><br><span class="line">      setNewGifs(arrayMove(newGifs, oldIndex, newIndex))</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们就可以自由的拖放了。</p>
<p><img src="http://fatge.xyz/static/img/drag-example-3.gif" alt></p>
<p>如图中所示，我们现在有两个单独的 GIF 列表，可以自由拖放。而且，它们是独立的意思，来自不同列表的项目不会混淆。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/22/install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yzz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yzz的神秘商店💪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/22/install/" class="post-title-link" itemprop="url">npm ci vs. npm install</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-22 14:35:58 / 修改时间：14:37:08" itemprop="dateCreated datePublished" datetime="2019-08-22T14:35:58+08:00">2019-08-22</time>
            </span>
          

          
            

            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/node/" itemprop="url" rel="index"><span itemprop="name">node</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>翻译 <a href="https://medium.com/better-programming/npm-ci-vs-npm-install-which-should-you-use-in-your-node-js-projects-51e07cb71e26。" target="_blank" rel="noopener">https://medium.com/better-programming/npm-ci-vs-npm-install-which-should-you-use-in-your-node-js-projects-51e07cb71e26。</a></p>
</blockquote>
<p><a href="https://www.npmjs.com/" target="_blank" rel="noopener">npm</a> 是 <a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node.js</a> 项目默认的包管理器。</p>
<p>使用 npm 可以轻松安装和更新依赖项。<a href="https://www.npmjs.com/" target="_blank" rel="noopener">npmjs</a> 上列出了可以使用的依赖项（例如Vue.js 框架），甚至还显示了可以复制并粘贴到终端的安装命令，如<code>npm i vue</code>。</p>
<p>如果你已经使用 npm 一段时间了，那么你将常用 npm install（或更短的 npm i）来安装或更新依赖项。</p>
<p>虽然这个安装命令仍然有效，但是在 npm v6 中还是引入了一个新的命令 - <code>npm ci</code>，那么它是用来<strong>做什么的</strong>？与 <code>npm i</code> 又有<strong>什么差异</strong>？</p>
<p style="text-align: center">. . .</p>

<h3 id="npm-install-简写-npm-i"><a href="#npm-install-简写-npm-i" class="headerlink" title="npm install (简写: npm i)"></a>npm install (简写: npm i)</h3><p><code>npm install</code>，或者 <code>npm i</code>，通常是用来安装依赖项：</p>
<ul>
<li>它将会安装 Node.js 项目所有的依赖项；</li>
<li>如果使用 <code>^</code> 或 <code>~</code> 来匹配依赖项的版本时，则 npm 可能无法安装确切版本；</li>
<li>利用 <code>npm install</code> 安装新依赖项时，会更新 package-lock.json。</li>
</ul>
<p style="text-align: center">. . .</p>

<h3 id="npm-ci"><a href="#npm-ci" class="headerlink" title="npm ci"></a>npm ci</h3><p>使用 <code>npm ci</code>，会发生：</p>
<ul>
<li>将会删除项目中的 <code>node_modules</code> 文件夹；</li>
<li>会依照项目中的 <code>package.json</code> 来安装确切版本的依赖项；</li>
<li>不像 <code>npm install</code>，<code>npm ci</code> 不会修改你的 <code>package-lock.json</code>。但是它确实期望你的项目中有一个 <code>package-lock.json</code> 文件 - 如果你没有这个文件，<code>npm ci</code> 将不起作用，此时必须使用 <code>npm install</code>。</li>
</ul>
<p>如果你使用 <code>npm ci</code>，你将获得<strong>可靠</strong>的构建。特别是当您在 Jenkins 或 GitLab CI 等<strong>持续集成工具</strong>中运行时，这将非常有用。</p>
<p style="text-align: center">. . .</p>

<h3 id="npm-ci-vs-npm-Install-—-该用哪一个？"><a href="#npm-ci-vs-npm-Install-—-该用哪一个？" class="headerlink" title="npm ci vs. npm Install — 该用哪一个？"></a>npm ci vs. npm Install — 该用哪一个？</h3><p><strong>如果你使用 npm v6+</strong>：</p>
<ul>
<li>使用 npm install 安装新的依赖项，或更新现有的依赖项（例如，从版本1到版本2）;</li>
<li>在持续集成工具中运行时使用 <code>npm ci</code>，或者某些不修改 package-lock.json 的情况下安装依赖项。</li>
</ul>
<p><strong>如果你使用 npm v5 或者更低的版本</strong>：</p>
<ul>
<li>只能通过 <code>npm install</code> 来安装或者更新依赖项；</li>
<li>尝试升级到最新的 npm 版本。除了<code>npm ci</code> 之外，它还具有 <code>npm audit</code> 命令，可以更轻松地识别和修复依赖项的安全漏洞。此外，使用 <code>npm v6</code> 安装依赖项应该更快。</li>
</ul>
<p style="text-align: center">. . .</p>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>如您所见，这两个命令都有其适用地场景。如果可能的话，我建议使用 <code>npm ci</code>，因为它可靠地完成它的工作，并使用 <code>npm install</code> 来安装新的依赖项或更新现有的依赖项。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/02/js-coercion/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yzz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yzz的神秘商店💪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/02/js-coercion/" class="post-title-link" itemprop="url">一言难尽的 JS  Coercion</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-02 11:40:59 / 修改时间：11:42:24" itemprop="dateCreated datePublished" datetime="2019-08-02T11:40:59+08:00">2019-08-02</time>
            </span>
          

          
            

            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>题目来源：<a href="http://javascript-puzzlers.herokuapp.com/。" target="_blank" rel="noopener">http://javascript-puzzlers.herokuapp.com/。</a></p>
</blockquote>
<p>来来来，小火汁，先用下面六道题目来试试水</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = [<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> ([<span class="number">0</span>]) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a == <span class="literal">true</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"wut"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//log false</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'5'</span> + <span class="number">3</span>; <span class="comment">// log "53"</span></span><br><span class="line"><span class="string">'5'</span> - <span class="number">3</span>; <span class="comment">// log "2"</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = [<span class="number">1</span>,<span class="number">2</span>];</span><br><span class="line"><span class="keyword">let</span> b = [<span class="number">3</span>,<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">a + b; <span class="comment">// "1,23,4"</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span> == [[[<span class="number">2</span>]]]</span><br><span class="line"></span><br><span class="line"><span class="comment">// log true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[] == []</span><br><span class="line"><span class="comment">// log false</span></span><br><span class="line"></span><br><span class="line">[] == ![]</span><br><span class="line"><span class="comment">// log true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> b = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> c = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">a == b;</span><br><span class="line">a === b;</span><br><span class="line">a &gt; c;</span><br><span class="line">a &lt; c;</span><br><span class="line"></span><br><span class="line"><span class="comment">// log false, false, false, true</span></span><br></pre></td></tr></table></figure>

<p>细心的你一定看出来了，上述五道题目都与 JS 的类型相关，再细一点的话，应该是与<strong>类型转换</strong>相关。</p>
<p>引用 <a href="https://github.com/getify/You-Dont-Know-JS" target="_blank" rel="noopener">You Don’t Know JS</a> 的结论，我们可以将类型转换分为：隐式转换（Implicit coercion）、显式转换（Explicit coercion）。</p>
<h3 id="显式转换"><a href="#显式转换" class="headerlink" title="显式转换"></a>显式转换</h3><p>我们<strong>主动</strong>的将一些变量按照我们的期望进行转变。那么有几种方法呢？</p>
<h4 id="ToNumer"><a href="#ToNumer" class="headerlink" title="ToNumer"></a>ToNumer</h4><blockquote>
<p>参考 <a href="https://www.ecma-international.org/ecma-262/5.1/#sec-9.3。" target="_blank" rel="noopener">https://www.ecma-international.org/ecma-262/5.1/#sec-9.3。</a></p>
</blockquote>
<p>其他类型转换为 <code>number</code> 类型的几种方法</p>
<figure class="table" id="block460">
                    <table>
                        <tbody>
                            <tr>
                                <th>输入类型</th><th>结果</th>
                            </tr>
                            <tr>
                                <td>Undefined</td><td>NaN</td>
                            </tr>
                            <tr>
                                <td>Null</td><td>+0</td>
                            </tr>
                            <tr>
                                <td>Boolean</td><td>如果参数是 true，结果为 1。如果参数是 false，此结果为 +0。</td>
                            </tr>
                            <tr>
                                <td>Number</td><td>结果等于输入的参数（不转换）。</td>
                            </tr>
                            <tr>
                                <td>String</td><td><code>string</code> ---> <code>number</code></td>
                            </tr>
                            <tr>
                                <td>Object</td>
                                <td><code>object</code> ---> <code>number</code></td>
                        </tr>
                    </tbody>
                </table>
            </figure>

<ul>
<li><p><code>string</code> —&gt; <code>number</code> </p>
<p>这个过程类似于判断字符串是否为一个字符串数值常量，例如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="string">'1'</span></span><br><span class="line"><span class="keyword">let</span> b = <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Number</span>(a)) <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Number</span>(b)) <span class="comment">// NaN</span></span><br><span class="line"><span class="built_in">console</span>.log(+a) <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(+b) <span class="comment">// NaN</span></span><br></pre></td></tr></table></figure>

<p>其中，在开源的 JS 社区中一般将 <code>+</code> 视为一个 <em>明确的</em> 强制转换形式。</p>
<p>同时，这个转换过程中也包含着一些细节，类似于 <code>Number(&quot;&quot;) // 0</code> 等，具体可见 <a href="https://www.ecma-international.org/ecma-262/5.1/#sec-9.3.1。" target="_blank" rel="noopener">https://www.ecma-international.org/ecma-262/5.1/#sec-9.3.1。</a></p>
</li>
</ul>
<blockquote>
<p>Number(a) 可以的话，那么 new Number(a) 可以么？可见 <a href="https://juejin.im/post/5d37adcff265da1bb13f7347。" target="_blank" rel="noopener">https://juejin.im/post/5d37adcff265da1bb13f7347。</a></p>
</blockquote>
<ul>
<li><p><code>object</code> —&gt; <code>number</code></p>
<p>这个过程可以分为两部，<code>object</code> –&gt; <code>ToPrimitive(object)</code> –&gt; <code>number</code>。</p>
<p><code>ToPrimitive</code> 运算符把其值参数转换为非对象类型，也就是调用其内部的 <code>[[DefaultValue]]</code> 方法。</p>
<p><code>[[DefaultValue]] (hint)</code> 中 <code>hint</code> 为<strong>期望类型</strong>（很关键）：</p>
<ul>
<li>如果 <code>hint</code> 为 <code>number</code>：先 <code>Object.prototype.valueOf</code> ，如果结果为原始值，则返回，否则调用 <code>Object.prototype.toString</code>；</li>
<li>如果 <code>hint</code> 为 <code>string</code>：先 <code>Object.prototype.toString</code> ，如果结果为原始值，则返回，否则调用 <code>Object.prototype.valueOf</code> 。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123;</span><br><span class="line">    valueOf: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="number">42</span>; &#125;,</span><br><span class="line">    toString: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="number">4</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Number</span>(a)) <span class="comment">// 42</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">String</span>(a)) <span class="comment">// 4</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="ToString"><a href="#ToString" class="headerlink" title="ToString"></a>ToString</h4><blockquote>
<p><a href="https://www.ecma-international.org/ecma-262/5.1/#sec-9.8" target="_blank" rel="noopener">https://www.ecma-international.org/ecma-262/5.1/#sec-9.8</a></p>
</blockquote>
<figure class="table" id="block494">
                    <table>
                        <tbody>
                            <tr>
                                <th>输入类型</th><th>结果</th>
                            </tr>
                            <tr>
                                <td>Undefined</td><td>"undefined"</td>
                            </tr>
                            <tr>
                                <td>Null</td><td>"null"</td>
                            </tr>
                            <tr>
                                <td>Boolean</td><td>如果参数是 true，那么结果为 "true"。
                                <br>
                                如果参数是 false，那么结果为 "false"。</td>
                            </tr>
                            <tr>
                                <td>String</td><td>结果等于输入的参数（不转换）。</td>
                            </tr>
                            <tr>
                                <td>Number</td><td>见 <code>number</code>---><code>string</code></td>
                            </tr>
                            <tr>
                                <td>Object</td><td>见上文。</td>
                        </tr>
                    </tbody>
                </table>
            </figure>



<ul>
<li><p><code>number</code> —&gt; <code>string</code></p>
<p>与 <code>string</code> —&gt; <code>number</code> 类似，大体上是将字符串数值常量转为字符串，其中有些科学计数法的转化细节</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">String</span>(<span class="number">1e-1</span>) <span class="comment">// "0.1"</span></span><br></pre></td></tr></table></figure>

<p>还有一些 <code>NaN</code> 的细节，见参考。</p>
</li>
</ul>
<h4 id="ToBoolean"><a href="#ToBoolean" class="headerlink" title="ToBoolean"></a>ToBoolean</h4><blockquote>
<p><a href="https://www.ecma-international.org/ecma-262/5.1/#sec-9.2" target="_blank" rel="noopener">https://www.ecma-international.org/ecma-262/5.1/#sec-9.2</a></p>
</blockquote>
<p>相对于前两个，ToBoolean 的规则较为明确</p>
<figure class="table" id="block458">
                    <table>
                        <tbody>
                            <tr>
                                <th>输入类型</th><th>结果</th>
                            </tr>
                            <tr>
                                <td>Undefined</td><td>false</td>
                            </tr>
                            <tr>
                                <td>Null</td><td>false</td>
                            </tr>
                            <tr>
                                <td>Boolean</td><td>结果等于输入的参数（不转换）。</td>
                            </tr>
                            <tr>
                                <td>Number</td><td>如果参数是 +0, -0, 或 NaN，结果为 false ；否则结果为 true。</td>
                            </tr>
                            <tr>
                                <td>String</td><td>如果参数参数是空字符串（其长度为零），结果为 false，否则结果为 true。</td>
                            </tr>
                            <tr>
                                <td>Object</td><td>true</td>
                            </tr>
                        </tbody>
                    </table>
                </figure>

<p>除了几个特殊的 <code>undefined</code>，<code>null</code>，<code>0</code>，<code>&quot;&quot;</code>，<code>NaN</code>，其他的一律转为 <code>true</code>。主要的转换方法，<code>Boolean</code> 以及 <code>!!</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="string">"0"</span>;</span><br><span class="line"><span class="keyword">let</span> b = [];</span><br><span class="line"><span class="keyword">let</span> c = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> d = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">let</span> e = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> f = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> g;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Boolean</span>( a ); <span class="comment">// true</span></span><br><span class="line">!!a; 		  <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Boolean</span>( b ); <span class="comment">// true</span></span><br><span class="line">!!a;		  <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Boolean</span>( c ); <span class="comment">// true</span></span><br><span class="line">!!c;          <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Boolean</span>( d ); <span class="comment">// false</span></span><br><span class="line">!!d;		  <span class="comment">// false</span></span><br><span class="line"><span class="built_in">Boolean</span>( e ); <span class="comment">// false</span></span><br><span class="line">!!e;          <span class="comment">// false</span></span><br><span class="line"><span class="built_in">Boolean</span>( f ); <span class="comment">// false</span></span><br><span class="line">!!f;          <span class="comment">// false</span></span><br><span class="line"><span class="built_in">Boolean</span>( g ); <span class="comment">// false</span></span><br><span class="line">!!g;          <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h3 id="隐式转换（一般伴随着表达式、操作符）"><a href="#隐式转换（一般伴随着表达式、操作符）" class="headerlink" title="隐式转换（一般伴随着表达式、操作符）"></a>隐式转换（一般伴随着<strong>表达式、操作符</strong>）</h3><p>当我们在使用<strong>条件表达式</strong>或者一些<strong>运算、相等操作符</strong>时，如果不注意，就会发生隐式的类型转换。</p>
<h4 id="判断语句"><a href="#判断语句" class="headerlink" title="判断语句"></a>判断语句</h4><p>主要有一下五种情况。</p>
<ol>
<li>在一个<code>if (..)</code>语句中的条件表达式；</li>
<li>在一个<code>for ( .. ; .. ; .. )</code> 中间的条件表达式；</li>
<li>在 <code>while (..)</code> 和 <code>do..while(..)</code> 循环中的条件表达式；</li>
<li>在<code>? :</code>三元表达式中的条件表达式（第一个子句）；</li>
<li><code>||</code>（“逻辑或”）和<code>&amp;&amp;</code>（“逻辑与”）操作符左手边的操作数。</li>
</ol>
<p>在日常的开发中，我们通常不会将判断语语句中的 <code>condition</code> 的结果强制转换为 <code>boolean</code>，例如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">42</span></span><br><span class="line"><span class="keyword">let</span> b = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (a) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log( <span class="string">"yep"</span> ); <span class="comment">// yep</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (b) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log( <span class="string">"forever running"</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时我们已经默认使用隐式转换来简化代码。而在没有默认参数的 ES5，我们也会使用，来为函数添加默认参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a;</span><br><span class="line"><span class="keyword">let</span> b = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line">a || b;		<span class="comment">// 42</span></span><br></pre></td></tr></table></figure>

<p>或者利用 <code>&amp;&amp;</code> 来简化 <code>if</code> 语句</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">let</span> b = <span class="string">"abc"</span>;</span><br><span class="line"></span><br><span class="line">a &amp;&amp; b;		<span class="comment">// "abc"</span></span><br></pre></td></tr></table></figure>

<p>所以在第一道题目中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = [<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> ([<span class="number">0</span>]) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a == <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// [0] 会转化为 true</span></span><br></pre></td></tr></table></figure>

<h4 id="、-运算符"><a href="#、-运算符" class="headerlink" title="+、- 运算符"></a><code>+</code>、<code>-</code> 运算符</h4><blockquote>
<p><a href="https://www.ecma-international.org/ecma-262/5.1/#sec-11.6.1" target="_blank" rel="noopener">https://www.ecma-international.org/ecma-262/5.1/#sec-11.6.1</a></p>
</blockquote>
<p>根据ES5语言规范，如果两个操作数之一已经是一个 <code>string</code>，或者下列步骤产生一个 <code>string</code> 表达形式，<code>+</code> 将会进行连接。</p>
<p>所以题目中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'5'</span> + <span class="number">3</span>; <span class="comment">// log "53"</span></span><br></pre></td></tr></table></figure>

<p>但，如果当 <code>+</code> 的两个操作数之一收到一个object（包括array）时，它首先在这个值上调用 <code>ToPrimitive</code>，例如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'5'</span> + [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">// "51,2,3"</span></span><br></pre></td></tr></table></figure>

<p>会将 <code>[1,2,3]</code> 转为了 <code>string</code> 调用 <code>toString</code>，至于原因见上文。</p>
<p>所以第三题目中，<code>a</code> 和 <code>b</code> 分别被转化为 <code>&quot;1,2&quot;</code> 以及 <code>&quot;3,4&quot;</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = [<span class="number">1</span>,<span class="number">2</span>];</span><br><span class="line"><span class="keyword">let</span> b = [<span class="number">3</span>,<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">a + b; <span class="comment">// "1,23,4"</span></span><br></pre></td></tr></table></figure>

<p>而一元 <code>-</code> 运算符将其操作数转换为 <code>number</code> 类型，所以</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'5'</span> - <span class="number">3</span>; <span class="comment">// log 2</span></span><br></pre></td></tr></table></figure>

<h4 id="以及-相等操作符"><a href="#以及-相等操作符" class="headerlink" title="== 以及 === 相等操作符"></a><code>==</code> 以及 <code>===</code> 相等操作符</h4><blockquote>
<p><a href="https://www.ecma-international.org/ecma-262/5.1/#sec-11.9.1" target="_blank" rel="noopener">https://www.ecma-international.org/ecma-262/5.1/#sec-11.9.1</a></p>
</blockquote>
<p>最为常考，开发用的少，面试用的多的 <code>==</code> 来了，这里引用一句You Don’t Know JS 中的一句话</p>
<blockquote>
<p>“<code>==</code> allows coercion in the equality comparison and <code>===</code> disallows coercion.”</p>
</blockquote>
<p><code>==</code> 与 <code>===</code> 的本质区别在与 <code>coercion</code> 也就是说本质在于是否发生了<strong>强制类型转换</strong>。那么 <code>==</code> 是如何转化类型的呢？</p>
<p>以 <code>x == y</code> 为例（篇幅所限省略，x、y 类型相同的规则，见参考地址）</p>
<ul>
<li><code>x</code> 为 <code>null</code> 且 <code>y</code> 为 <code>undefined</code>， 返回 <code>true</code>;</li>
<li><code>x</code> 为 <code>undefined</code> 且 <code>y</code> 为 <code>null</code>，返回 <code>true</code>;</li>
<li>若 Type(x) 为 <code>number</code> 且 Type(y) 为 <code>string</code>，返回 <code>x == ToNumber(y)</code> 的结果;</li>
<li>Type(x) 为 <code>string</code> 且 Type(y) 为 <code>number</code>，返回 <code>ToNumber(x) == y</code>的结果;</li>
<li>Type(x) 为 <code>boolean</code>，返回 <code>ToNumber(x) == y</code> 的结果;</li>
<li>Type(y) 为 <code>boolean</code>，返回 <code>x == ToNumber(y)</code> 的结果;</li>
<li>Type(x) 为 <code>string</code> 或 <code>number</code>，且 <code>Type(y)</code> 为 <code>object</code>，返回 <code>x == ToPrimitive(y)</code> 的结果;</li>
<li>Type(x) 为 <code>object</code> 且 Type(y) 为 <code>string</code> 或 <code>number</code>， 返回比较<code>ToPrimitive(x)  ==  y</code> 的结果。</li>
</ul>
<p>看似很多，其实本质上满足两条：</p>
<ul>
<li>如果 x，y 的类型为非引用类型，将其转化为 <code>number</code> 进行对比；</li>
<li>如果 x，y 的类型为引用类，将调用 <code>ToPrimitive</code> 转化为基础值进行对比。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span> == <span class="string">'2'</span> <span class="comment">// true</span></span><br><span class="line"><span class="number">1</span> == <span class="literal">true</span> <span class="comment">// true</span></span><br><span class="line"><span class="number">0</span> == <span class="literal">false</span> <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>而题目中，<code>[[[2]]]</code> 需要获取 <code>ToPrimitive</code>  的结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span> == [[[<span class="number">2</span>]]]</span><br><span class="line"><span class="comment">// [[[2]]] 调用 valueOf() 得到 [Array(1)] 非基础类型</span></span><br><span class="line"><span class="comment">// [[[2]]] 调用 toString() 得到 2</span></span><br><span class="line"><span class="comment">// log true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[] == []</span><br><span class="line"><span class="comment">// [] 与 [] 类型都为 object，所以比对是否引用同一个对象</span></span><br><span class="line"><span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">[] == ![]</span><br><span class="line"><span class="comment">// ![] 强制转化为 boolean，false，</span></span><br><span class="line"><span class="comment">// ![] 转化为 boolean，所以 [] 需要利用 ToPrimitive 得到 ""</span></span><br><span class="line"><span class="comment">// 原式变为 "" == false，false 转化为 0，而 "" 也变为 0</span></span><br><span class="line"><span class="comment">// log true</span></span><br></pre></td></tr></table></figure>

<p>同样还有 <code>&gt;</code>，<code>&lt;</code></p>
<blockquote>
<p><a href="https://www.ecma-international.org/ecma-262/5.1/#sec-11.8" target="_blank" rel="noopener">https://www.ecma-international.org/ecma-262/5.1/#sec-11.8</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> b = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> c = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">a == b; <span class="comment">// 非同一引用</span></span><br><span class="line">a === b; <span class="comment">// 非同一引用</span></span><br><span class="line">a &gt; c; <span class="comment">// a 转化为 "1,2,3"，c 转化为 "1,2,4"</span></span><br><span class="line">a &lt; c;</span><br><span class="line"></span><br><span class="line"><span class="comment">// log false, false, false, true</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/30/profile-analyse-vue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yzz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yzz的神秘商店💪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/30/profile-analyse-vue/" class="post-title-link" itemprop="url">利用 Profiler 分析 Vue Render 性能问题</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-30 09:06:25" itemprop="dateCreated datePublished" datetime="2019-07-30T09:06:25+08:00">2019-07-30</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-08 18:02:12" itemprop="dateModified" datetime="2019-08-08T18:02:12+08:00">2019-08-08</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/chrome/" itemprop="url" rel="index"><span itemprop="name">chrome</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近在开发一套组件库，期间在实现<a href="https://juejin.im/post/5c2d9a49f265da6169175ae7" target="_blank" rel="noopener">InputNumber 组件</a>时候碰到一个诡异卡顿的现象，用了时间来排除这个问题，涉及到一些问题定位的方法，记录下来已备后用。</p>
</blockquote>
<hr>
<h3 id="1-发现问题"><a href="#1-发现问题" class="headerlink" title="1. 发现问题"></a>1. 发现问题</h3><p>在实现 InputNumber 组件的时候，有一个功能是按住 + 或 - 按钮时，组件的值在不断的自增或者自减，当组件的值自增到一定数量之后，组件会开始卡顿，并且页面上下滚动也会有明显的延迟。</p>
<p><a href="https://fatge.xyz/blog/juejin-example-4#/InputNumber" target="_blank" rel="noopener">问题体验</a></p>
<p><a href="https://github.com/FatGe/UI-Library/tree/inputNumber-bug" target="_blank" rel="noopener">相关代码</a></p>
<h3 id="2-定位问题"><a href="#2-定位问题" class="headerlink" title="2. 定位问题"></a>2. 定位问题</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">  name: <span class="string">"input-number"</span>,</span></span><br><span class="line">  ...</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleClick(type) &#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> &#123; step &#125; = <span class="keyword">this</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> period = <span class="number">10</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> timerHandle = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> &#123; addDisabled, decDisabled &#125; = <span class="keyword">this</span>;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (!addDisabled &amp;&amp; type === <span class="string">"add"</span>) <span class="keyword">this</span>.inputNumberValue += step;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (!decDisabled &amp;&amp; type === <span class="string">"dec"</span>) <span class="keyword">this</span>.inputNumberValue -= step;</span></span><br><span class="line">        &#125;;</span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> timer = setInterval(timerHandle, period);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> startTime = <span class="keyword">new</span> <span class="built_in">Date</span>();</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> handler = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> endTime = <span class="keyword">new</span> <span class="built_in">Date</span>();</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (endTime - startTime &lt; period) timerHandle();</span></span><br><span class="line"></span><br><span class="line">            clearInterval(timer);</span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.removeEventListener(<span class="string">"mouseup"</span>, handler, <span class="literal">false</span>);</span></span><br><span class="line">        &#125;;</span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.addEventListener(<span class="string">"mouseup"</span>, handler, <span class="literal">false</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先定位问题发生的位置，直观上感受应该是点击之后不无端自增发生的卡顿，对应代码中的 <code>handleClick</code> 函数，它将 <code>click</code> 事件分为 <code>mousedown</code> 以及 <code>mouseup</code>，当触发 <code>mousedown</code> 事件时候，调用一个 <code>setInterval</code> 定时执行组件值变化的函数。</p>
<p>初步定位问题应该就发生在 <code>timerHandle</code> 之后，当 <code>inputNumberValue</code> 发生变化之后，它会按照一定的规则来改变 <code>inputValue</code> 的值，从而触发 <code>$emit(input, this.inputValue)</code> 来完成 <code>v-model</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">computed: &#123;</span><br><span class="line">    inputNumberValue: &#123;</span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.inputValue;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            <span class="comment">// ...一定规则</span></span><br><span class="line">            <span class="keyword">this</span>.inputValue = limits.find(<span class="function"><span class="params">limit</span> =&gt;</span> limit.need(value)).value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">watch: &#123;</span><br><span class="line">    value: &#123;</span><br><span class="line">        handler(newVal) &#123;</span><br><span class="line">            <span class="built_in">console</span>.timeEnd()</span><br><span class="line">            <span class="keyword">this</span>.inputNumberValue = newVal;</span><br><span class="line">        &#125;,</span><br><span class="line">        immediate: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    inputValue(newVal) &#123; </span><br><span class="line">        <span class="keyword">this</span>.$emit(<span class="string">"input"</span>, newVal);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用 <code>console.time</code> 以及 <code>console.timeEnd</code> 来排查，那一步发生的卡顿，检测整个 <code>v-model</code> 变化的流程。</p>
<p>也就是在 <code>timerHandle</code> 以及 <code>watch value handler</code> 内添加 <code>console.time</code> 以及 <code>console.timeEnd</code> ，具体如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> timerHandle = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; addDisabled, decDisabled &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (!addDisabled &amp;&amp; type === <span class="string">"add"</span>) <span class="keyword">this</span>.inputNumberValue += step;</span><br><span class="line">    <span class="keyword">if</span> (!decDisabled &amp;&amp; type === <span class="string">"dec"</span>) <span class="keyword">this</span>.inputNumberValue -= step;</span><br><span class="line">    <span class="built_in">console</span>.time();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">watch: &#123;</span><br><span class="line">    value: &#123;</span><br><span class="line">        handler(newVal) &#123;</span><br><span class="line">            <span class="built_in">console</span>.timeEnd()</span><br><span class="line">            <span class="keyword">this</span>.inputNumberValue = newVal;</span><br><span class="line">        &#125;,</span><br><span class="line">        immediate: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后运行，发现运行时间是在不断地增加的，这时候问题的可以归类为，inputNumber 组件的值在不断地变动，导致的 <code>update</code> 的时间会不断地增长。</p>
<img src="https://user-gold-cdn.xitu.io/2019/1/4/16816eb850fd9181?w=1400&h=748&f=gif&s=1548132" width="600">

<p>接下来要判断具体是哪一句js导致整个页面的 <code>update</code> 时间不断地变长，利用 Chrome 的 JavaScript Profiler 来完成该工作。打开开发者工具</p>
<img src="https://user-gold-cdn.xitu.io/2019/1/4/16816f4370b701b6?w=1574&h=792&f=png&s=69148" width="600">

<p>利用这个面板你可以追踪网页程序的内存泄漏问题，进一步提升程序的JavaScript执行性能，点击Start 按钮，然后去复现刚才的操作，得到结果如下</p>
<img src="https://user-gold-cdn.xitu.io/2019/1/4/16816fbb7686db7b?w=1420&h=846&f=png&s=118800" width="600">

<p>图中标识处有三个模式：</p>
<ul>
<li>Chart 按时间先后顺序显示的火焰图；</li>
<li>Heavy(Bottom Up) 根据对性能的消耗影响列出所有的函数，并可以查看该函数的调用路径；</li>
<li>Tree(Top Down) 从调用栈的顶端（最初调用的位置）开始，显示调用结构的总体的树状图情况。</li>
</ul>
<p>选择 Tree(Top Down) 模式，得到结果如下</p>
<img src="https://user-gold-cdn.xitu.io/2019/1/4/168173d261550a55?w=1428&h=203&f=png&s=21280" width="900">

<p>可以看出 <code>flushCallbacksvue</code> 函数占用了74.66%的 Total Time，所以需要对它进行分析</p>
<img src="https://user-gold-cdn.xitu.io/2019/1/4/168174180f1101ce?w=1171&h=790&f=png&s=110720" width="900">

<p>在它的调用栈中，关键的一步是 <code>Vue._update</code> ，它的主要功能是将 <code>Vnode</code> 渲染成真实DOM，所以上述的卡顿问题果然出现在渲染这一步。</p>
<p>继续分析，发现主要问题在与 <code>updateDirctives</code> 这个函数内，看来问题和指令的更新相关。</p>
<p>最后，发现原来是 <code>highlightBlock</code> 的锅，因为要完成页面中代码高亮的需求，开发了一个指令</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hljs <span class="keyword">from</span> <span class="string">'highlight.js/lib/highlight'</span>;</span><br><span class="line"></span><br><span class="line">Vue.directive (<span class="string">'highlight'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> blocks = el.querySelectorAll (<span class="string">'code'</span>);</span><br><span class="line">    <span class="built_in">Array</span>.prototype.forEach.call (blocks, block =&gt; &#123;</span><br><span class="line">        hljs.highlightBlock (block);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当 InputNumber 组件 <code>v-model</code> 所绑定的父组件 <code>data</code> 变动时候，会导致 <code>v-highlight</code> 指令不断地更新，使得页面卡顿。</p>
<h3 id="3-解决问题"><a href="#3-解决问题" class="headerlink" title="3. 解决问题"></a>3. 解决问题</h3><p>只需要将该指令的高亮代码的函数写在 <code>bind</code> 里面，这样就只调用一次，指令第一次绑定到元素时调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Vue.directive (<span class="string">'highlight'</span>, &#123;</span><br><span class="line">    bind (el) &#123;</span><br><span class="line">        <span class="keyword">let</span> blocks = el.querySelectorAll (<span class="string">'code'</span>);</span><br><span class="line">        <span class="built_in">Array</span>.prototype.forEach.call (blocks, block =&gt; &#123;</span><br><span class="line">            hljs.highlightBlock (block);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>欢迎Star：<a href="https://github.com/FatGe/FatGe.github.io" target="_blank" rel="noopener">https://github.com/FatGe/FatGe.github.io</a></p>
</blockquote>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/26/react-lifecycle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yzz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yzz的神秘商店💪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/26/react-lifecycle/" class="post-title-link" itemprop="url">React v16 生命周期函数详解：如何、何时使用它们（React 组件生命周期的修订和最新指南）</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-26 14:52:25 / 修改时间：15:01:00" itemprop="dateCreated datePublished" datetime="2019-07-26T14:52:25+08:00">2019-07-26</time>
            </span>
          

          
            

            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>翻译自  <a href="https://blog.bitsrc.io/react-16-lifecycle-methods-how-and-when-to-use-them-f4ad31fb2282" target="_blank" rel="noopener">React 16 Lifecycle Methods: How and When to Use Them</a>，作者：<a href="https://blog.bitsrc.io/@scottdomes" target="_blank" rel="noopener">Scott Domes</a></p>
<p>参考 <a href="https://reactjs.org/docs/react-component.html" target="_blank" rel="noopener">React.Component</a></p>
</blockquote>
<p><em>概述：最近在学习 react v16.8.4，发现组件的生命周期发生了一些变化，原有的一些方法被废弃，所以看了官方API介绍，再结合上述文章，做个总结。</em></p>
<p>由于这次生命周期 API 有点复杂，我将这些方法分为四个部分：安装（Mounting），更新（Updating），卸载（Unmounting）和异常（Error）。</p>
<hr>
<h3 id="Mounting-组件的挂载"><a href="#Mounting-组件的挂载" class="headerlink" title="Mounting - 组件的挂载"></a>Mounting - 组件的挂载</h3><p>├── <a href="https://reactjs.org/docs/react-component.html#constructor" target="_blank" rel="noopener"><strong>constructor</strong></a></p>
<p>├── <a href="https://reactjs.org/docs/react-component.html#static-getderivedstatefromprops" target="_blank" rel="noopener"><strong>static getDerivedStateFromProps</strong></a></p>
<p>├── <a href="https://reactjs.org/docs/react-component.html#render" target="_blank" rel="noopener"><strong>render</strong></a></p>
<p>├── <a href="https://reactjs.org/docs/react-component.html#componentdidmount" target="_blank" rel="noopener"><strong>componentDidMount</strong></a></p>
<h4 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a>constructor</h4><blockquote>
<p>如果您的组件是 Class Component，则调用的第一就是组件构造函数。 这不适用于 Functional Component。</p>
</blockquote>
<p>相关构造函数可能是如下形式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      counter: <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造函数的参数为 props，<strong>你可以利用 <code>super</code> 来传入</strong>。</p>
<p>在构造函数中，你可以初始化 state、设定默认值。甚至你可以依据 props 来创建 state。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      counter: props.initialCounterValue,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>，现在构造函数是可选的，如果您的 Babel 设置支持 class fields，就可以像这样初始化状态：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    counter: <span class="number">0</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>这种方法是被大家所提倡的</strong>。 你仍然可以根据 props 创建 state：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    counter: <span class="keyword">this</span>.props.initialCounterValue,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，如果需要使用 ref ，就仍需要构造函数。 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grid</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      blocks: [],</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 在 constructor 中创建 ref</span></span><br><span class="line">    <span class="keyword">this</span>.grid = React.createRef();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要构造函数来调用 createRef，以创建对 <strong>HTMLElement</strong> 元素的引用。还可以使用构造函数进行函数绑定，这也是可选的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grid</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      blocks: [],</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">this</span>.handleChange.bind(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 2 等同于 1</span></span><br><span class="line">  handleChange = <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>constructor总结：</strong> 构造函数的最常法：设置 state，创建 ref 和方法绑定。</p>
<h4 id="getDerivedStateFromProps"><a href="#getDerivedStateFromProps" class="headerlink" title="getDerivedStateFromProps"></a>getDerivedStateFromProps</h4><blockquote>
<p>挂载时，getDerivedStateFromProps 是渲染前调用的最后一个方法</p>
</blockquote>
<p> 一般使用 getDerivedStateFromProps 可以根据初始 props 使用它来设置状态。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> getDerivedStateFromProps(props, state) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">blocks</span>: createBlocks(props.numberOfBlocks) &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// log &#123;blocks: Array(20)&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span>.state);</span><br></pre></td></tr></table></figure>

<p>上述代码中依据 props.numberOfBlocks 来初始化期望的 state（函数return为状态）。</p>
<p><strong>注意：</strong> 我们可以将此代码放在 constructor 中，与之相 getDerivedStateFromProps的优点是它更<strong>直观</strong> - 它仅用于设置状态，而构造函数有多种用途。</p>
<p><strong>总结：</strong> getDerivedStateFromProps 的最常见用例（在mount期间）：根据初始props返回状态对象。</p>
<h4 id="render"><a href="#render" class="headerlink" title="render"></a>render</h4><p>完成所有渲染的工作。它返回实际组件的 JSX，使用React时，将花费大部分时间在这里。</p>
<p>渲染的最常见用例：返回 JSX 组件。</p>
<h4 id="componentDidMount"><a href="#componentDidMount" class="headerlink" title="componentDidMount"></a>componentDidMount</h4><blockquote>
<p>在第一次渲染组件之后，触发此方法。</p>
</blockquote>
<p>如果需要加载数据，请在此处执行。 不要尝试在 constructor 中加载数据或渲染，原因，<a href="https://tylermcginnis.com/react-interview-questions/" target="_blank" rel="noopener">react-interview-questions</a>.</p>
<blockquote>
<p>由于AJAX是异步的，所以无法保证在组件挂载之前 AJAX 请求完成解析。 如果确实如此，那就意味着你要在未挂载的组件上尝试 setState，这不仅不起作用，而且 React 报错。 在componentDidMount中执行 AJAX 将保证有一个要更新的组件。</p>
</blockquote>
<p>componentDidMount 触发时，组件已完成第一 render，所以可以进行一些操作：</p>
<ul>
<li>在刚刚渲染的 <code>&lt;canvas&gt;</code> 元素上进行绘制</li>
<li>访问 DOM 节点</li>
<li>添加事件侦听器</li>
</ul>
<p>基本上，在这里你可以做所有依赖 DOM 的设置，并开始获得你需要的所有数据，例如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">    <span class="comment">// 利用 ref 访问 dom 元素</span></span><br><span class="line">    <span class="keyword">this</span>.bricks = initializeGrid(<span class="keyword">this</span>.grid.current);</span><br><span class="line">    <span class="keyword">this</span>.interval = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// ajax 获取数据</span></span><br><span class="line">      <span class="keyword">this</span>.addBlocks();</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong> 调用 AJAX 以加载组件的数据。</p>
<h3 id="Updating-组件的更新"><a href="#Updating-组件的更新" class="headerlink" title="Updating - 组件的更新"></a>Updating - 组件的更新</h3><p>├── <a href="https://reactjs.org/docs/react-component.html#static-getderivedstatefromprops" target="_blank" rel="noopener"><strong>static getDerivedStateFromProps</strong></a> </p>
<p>├── <a href="https://reactjs.org/docs/react-component.html#shouldcomponentupdate" target="_blank" rel="noopener"><strong>shouldComponentUpdate</strong></a></p>
<p>├── <a href="https://reactjs.org/docs/react-component.html#render" target="_blank" rel="noopener"><strong>render</strong></a></p>
<p>├── <a href="https://reactjs.org/docs/react-component.html#getsnapshotbeforeupdate" target="_blank" rel="noopener"><strong>getSnapshotBeforeUpdate</strong></a></p>
<p>├── <a href="https://reactjs.org/docs/react-component.html#shouldcomponentupdate" target="_blank" rel="noopener"><strong>componentDidUpdate</strong></a></p>
<h4 id="getDerivedStateFromProps-1"><a href="#getDerivedStateFromProps-1" class="headerlink" title="getDerivedStateFromProps"></a>getDerivedStateFromProps</h4><blockquote>
<p>是的，再来一次。 现在，它更有用了。</p>
</blockquote>
<p>如果您需要根据 props 来更新 state，可以通过 return 新的状态对象来完成该任务。</p>
<p><strong>注，不建议依据 props 来处理 state</strong>，也就是说，只有逼不得已才使用该方法。 以下是一些例子：</p>
<ul>
<li>当 video 、audio 的 source 改变时，需要重置元素；</li>
<li>Server 资源更新后需要恢复 UI 元素；</li>
<li>当内容改变时关闭相关元素。</li>
</ul>
<p>即使有上述情况，通常也有更好的方法。 但是 getDerivedStateFromProps 可以情况变得更坏。</p>
<p><strong>总结：</strong> getDerivedStateFromProps 一般用于 props 不足以支撑业务时，利用它来更新 state。</p>
<p><strong>shouldComponentUpdate</strong></p>
<blockquote>
<p>典型的 React 哲学，当一个组件收到新的 State 或 Props时，它应该更新。</p>
</blockquote>
<p>但我们的组件有点困惑，它不确定是否要进行更新。</p>
<p>shouldComponentUpdate 方法的第一个参数为 nextProps，第二个参数为 nextState。shouldComponentUpdate 返回一个布尔值，用于控制组件是否更新。</p>
<p>shouldComponentUpdate 赋予我们一项能力，只有在你关心的 props 改变时组件会才更新。</p>
<p><strong>总结：</strong> 可以准确地控制组件重新渲染的时间，常用于优化 React，<a href="https://medium.freecodecamp.org/react-binding-patterns-5-approaches-for-handling-this-92c651b5af56" target="_blank" rel="noopener">具体</a>。</p>
<h4 id="render-同上"><a href="#render-同上" class="headerlink" title="render - 同上"></a>render - 同上</h4><h4 id="getSnapshotBeforeUpdate"><a href="#getSnapshotBeforeUpdate" class="headerlink" title="getSnapshotBeforeUpdate"></a>getSnapshotBeforeUpdate</h4><blockquote>
<p>新添加的方法，触发时刻在 render 之后，最新的渲染输出提交给 DOM 之前。</p>
</blockquote>
<p>调用渲染和最后显示更改之间可能会有延迟， 如果你需要获取 DOM 改变之前的一些信息时，可以利用这个钩子函数。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/28/169c43c6f8861ce2?w=1280&h=720&f=png&s=11387" alt></p>
<p>从渲染到提交这个过程是异步的，所以如果在 componentWillUpdate 访问 DOM 信息，在 componentDidUpdate 使用时，该信息可能发生了修改，这一部分以官网的例子来说明</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScrollingList</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  listRef = React.createRef();</span><br><span class="line"></span><br><span class="line">  getSnapshotBeforeUpdate(prevProps, prevState) &#123;</span><br><span class="line">    <span class="comment">// 如果在列表中添加新项目</span></span><br><span class="line">    <span class="comment">// 获取列表的当前高度，以便我们稍后调整滚动</span></span><br><span class="line">    <span class="keyword">if</span> (prevProps.list.length &lt; <span class="keyword">this</span>.props.list.length) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.listRef.current.scrollHeight;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidUpdate(prevProps, prevState, snapshot) &#123;</span><br><span class="line">    <span class="comment">// 如果我们 snapshot 的值不为空，说明添加了新项目</span></span><br><span class="line">    <span class="comment">// 调整滚动，以便这些新项目不会将旧项目推出可视区域</span></span><br><span class="line">    <span class="keyword">if</span> (snapshot !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.listRef.current.scrollTop +=</span><br><span class="line">        <span class="keyword">this</span>.listRef.current.scrollHeight - snapshot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div ref=&#123;<span class="keyword">this</span>.listRef&#125;&gt;&#123;<span class="comment">/* ...contents... */</span>&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong> 查看当前 DOM 的某些属性，并将该值传递给componentDidUpdat。</p>
<h4 id="componentDidUpdate"><a href="#componentDidUpdate" class="headerlink" title="componentDidUpdate"></a>componentDidUpdate</h4><blockquote>
<p>所有的改变都已经提交给 DOM。</p>
</blockquote>
<p>componentDidUpdate 包含三个参数，之前的 props、state，以及 getSnapshotBeforeUpdate 的返回值，具体如上述例子。</p>
<p><strong>总结：</strong> 对已经改变的 Dom 作出相关响应。</p>
<h3 id="Unmounting"><a href="#Unmounting" class="headerlink" title="Unmounting"></a>Unmounting</h3><h4 id="componentWillUnmount"><a href="#componentWillUnmount" class="headerlink" title="componentWillUnmount"></a>componentWillUnmount</h4><blockquote>
<p>组件快要结束了。</p>
</blockquote>
<p>在组件注销之前，它会询问您是否有任何最后一刻的请求。</p>
<p>您可以在此处取消任何传出网络请求，或删除与该组件关联的所有事件侦听器。</p>
<p>基本上，清理任何事情都只涉及有问题的组件 - 当它消失时，它应该完全消失。</p>
<p><strong>总结：</strong> 清除事件监听、定时器等，防止内存泄漏。</p>
<h3 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h3><h4 id="getDerivedStateFromError"><a href="#getDerivedStateFromError" class="headerlink" title="getDerivedStateFromError"></a>getDerivedStateFromError</h4><blockquote>
<p>发生了一些异常。</p>
</blockquote>
<p>它能够捕捉在他们的子组件树中任意地方的 JavaScript 错误，记录这些错误。当我们要展示一个 error 页面时，可以利用它来完成。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> getDerivedStateFromError(error) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">hasError</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> 您必须返回更新的状态对象。 不要将此方法用于任何副作用。 而是使用下面的 componentDidCatch。</p>
<p><strong>总结：</strong> 依据错误信息来修改组件的 state，同时展示出 error 页面。</p>
<h4 id="componentDidCatch"><a href="#componentDidCatch" class="headerlink" title="componentDidCatch"></a>componentDidCatch</h4><blockquote>
<p>与上面非常相似，因为它在子组件中发生错误时被触发。</p>
</blockquote>
<p>与 getDerivedStateFromError 区别在于不是为了响应错误而更新状态，可以执行任何副作用，例如记录错误。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">componentDidCatch(error, info) &#123;</span><br><span class="line">  sendErrorLog(error, info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> componentDidCatch 仅会捕获渲染/生命周期方法中的错误。 如果在单击处理程序中引发错误，则不会捕获它。</p>
<p>通常只在特殊的地方使用错误边界组件的 componentDidCatch。 这些组件包装子树的唯一目的是捕获和记录错误。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorBoundary</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">errorMessage</span>: <span class="literal">null</span> &#125;;</span><br><span class="line">  <span class="keyword">static</span> getDerivedStateFromError(error) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">errorMessage</span>: error.message &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidCatch(error, info) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error, info);</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state.errorMessage) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Oops! &#123;this.state.errorMessage&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.children;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong> 捕获、打印出错误信息。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>以上是React v16的生命周期钩子所适用的场景和具体使用方法。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/21/lodash-type-detection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yzz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yzz的神秘商店💪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/21/lodash-type-detection/" class="post-title-link" itemprop="url">Lodash 是如何做类型检测的</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-21 17:16:16" itemprop="dateCreated datePublished" datetime="2019-07-21T17:16:16+08:00">2019-07-21</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-30 08:56:24" itemprop="dateModified" datetime="2019-07-30T08:56:24+08:00">2019-07-30</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://fatge.xyz/static/img/js-types.png" alt="js 基本数据类型"></p>
<p>JS 的基本数据类型有 <code>Number</code>，<code>String</code>，<code>Boolean</code>，<code>Symbol</code>，<code>Null</code>，<code>Undefined</code>，六种数据类型。一种引用类型 <code>object</code>。</p>
<h3 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h3><h4 id="Number"><a href="#Number" class="headerlink" title="Number"></a>Number</h4><p>数值，根据 ECMAScript 标准，JavaScript 中只有一种数字类型：基于 IEEE 754 标准的双精度 64 位二进制格式的值（-(263 -1) 到 263 -1）。<strong>它并没有为整数给出一种特定的类型</strong>。</p>
<p>除了能够表示浮点数外，还有一些带符号的值：<code>+Infinity</code>，<code>-Infinity</code> 和 <code>NaN</code> (非数值，Not-a-Number)。</p>
<p>对应 <strong>lodash</strong> 中的检测函数有</p>
<ul>
<li><code>isNumber</code> 检查 <code>value</code> 是否是原始 <code>Number</code> 数值型 或者 对象；</li>
<li><code>isInteger</code> 检查 <code>value</code> 是否为一个整数；</li>
<li><code>isNaN</code> 检测 <code>value</code> 是否为 <code>NaN</code>；</li>
<li><code>isFinite</code> 检测 <code>value</code> 是否是原始有限数值。</li>
</ul>
<h5 id="isNumber"><a href="#isNumber" class="headerlink" title="isNumber"></a><code>isNumber</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isNumber</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> value == <span class="string">'number'</span> ||</span><br><span class="line">    (isObjectLike(value) &amp;&amp; getTag(value) == <span class="string">'[object Number]'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>typeof</code> 操作符可以返回一个字符串，表示未经计算的操作数的类型。对于 Number、String、Boolean、Undefined、String 可以很明确的得到它的类型。</p>
<p>那么 <strong>lodash</strong> 为什么还要添加 <code>(isObjectLike(value) &amp;&amp; getTag(value) == &#39;[object Number]&#39;)</code>？</p>
<p>原因在于，JS 中也允许我们以如下形式创建一个数值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = <span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">console</span>.log(value) <span class="comment">// log 1</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">typeof</span> value) <span class="comment">// log "object"</span></span><br></pre></td></tr></table></figure>

<p>这时，单单只是使用 <code>typeof</code> 操作符就没法判断 <code>value</code> 的类型是否为数值。所以要结合以下两个函数来判断，<code>value</code> 是否为 <code>object</code> 然后再通过过 <code>toString()</code>  来获取每个对象的类型。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTag</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> value === <span class="literal">undefined</span> ? <span class="string">'[object Undefined]'</span> : <span class="string">'[object Null]'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.toString.call(value)  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isObjectLike</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> value == <span class="string">'object'</span> &amp;&amp; value !== <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>Object.prototype.toString.call</code> 每个对象都有一个<code>toString()</code>方法，当该对象被表示为一个文本值时，或者一个对象以预期的字符串方式引用时自动调用。</p>
</blockquote>
<h5 id="isInteger"><a href="#isInteger" class="headerlink" title="isInteger"></a><code>isInteger</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isInteger</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">    	<span class="keyword">typeof</span> value == <span class="string">'number'</span> </span><br><span class="line">    	&amp;&amp; value == toInteger(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查 <code>value</code> 是否为一个整数，判断是否 <code>value</code> 的类型是否为数值，并且是否与 Int 型相同。其取整过程如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toInteger</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = toFinite(value),</span><br><span class="line">        remainder = result % <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result === result ? </span><br><span class="line">        (remainder ? result - remainder : result) : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="isNaN"><a href="#isNaN" class="headerlink" title="isNaN"></a><code>isNaN</code></h5><p>检查 <code>value</code> 是否是 <code>NaN</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isNaN</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> isNumber(value) &amp;&amp; value != +value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与 ES 2015 的 <code>isNaN</code> 不同的是，对于 <code>undefined</code>，<code>{}</code>，原生的结果是 <code>true</code>，而 <strong>lodash</strong> 为 <code>false</code>。这是因为如果<code>isNaN</code>函数的参数不是<code>Number</code>类型， <code>isNaN</code>函数会首先尝试将这个参数转换为数值，然后才会对转换后的结果是否是<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/NaN" target="_blank" rel="noopener"><code>NaN</code></a>进行判断。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js native isNaN</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">isNaN</span> = <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> n = <span class="built_in">Number</span>(value);</span><br><span class="line">    <span class="keyword">return</span> n !== n;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但是无论是 ES 2015 还是 <strong>lodash</strong>，它们本质上都是利用 <code>x != x</code> 来判断 <code>NaN</code>。</p>
<h5 id="isFinite"><a href="#isFinite" class="headerlink" title="isFinite"></a><code>isFinite</code></h5><p>检查 <code>value</code> 是否是原始有限数值。 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isFinite</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> value == <span class="string">'number'</span> </span><br><span class="line">    	&amp;&amp; nativeIsFinite(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用原生的 <code>isFinite</code> 结合 <code>typeof</code> 判断数字是否为有限值。</p>
<h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><p>String 类型用于表示由零或多个16 位Unicode 字符组成的字符序列，即字符串。用于保存可以以文本形式表示的数据非常有用。</p>
<p> 值得注意的是，不单单要注意<strong>基本字符串</strong>，还需要注意<strong>字符串对象</strong>，字符串字面量 (通过单引号或双引号定义) 和 直接调用 String 方法(没有通过 new 生成字符串对象实例)的字符串都是基本字符串。</p>
<blockquote>
<p>JavaScript会自动将基本字符串转换为字符串对象，只有将基本字符串转化为字符串对象之后才可以使用字符串对象的方法。</p>
</blockquote>
<p>与之前的 number 类似，利用构造函数 <code>String</code> 创建的字符串是一个 <code>object</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s_prim = <span class="string">"foo"</span>;</span><br><span class="line"><span class="keyword">const</span> s_obj = <span class="keyword">new</span> <span class="built_in">String</span>(s_prim);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">typeof</span> s_prim); <span class="comment">// Logs "string"</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">typeof</span> s_obj);  <span class="comment">// Logs "object"</span></span><br></pre></td></tr></table></figure>

<p>所以检测字符串，除了基本字符串以外还要注意字符串对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isString</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> type = <span class="keyword">typeof</span> value</span><br><span class="line">  <span class="keyword">return</span> </span><br><span class="line">    type == <span class="string">'string'</span> || </span><br><span class="line">        (type == <span class="string">'object'</span> </span><br><span class="line">         	&amp;&amp; value != <span class="literal">null</span> </span><br><span class="line">         	&amp;&amp; !<span class="built_in">Array</span>.isArray(value) </span><br><span class="line">         	&amp;&amp; getTag(value) == <span class="string">'[object String]'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以利用 <code>typeof</code> 检测基本字符串，对于模板字符串采用了之前介绍的方案  <code>getTag</code> 来获取 <code>value</code> 的类型。</p>
<h4 id="Boolean"><a href="#Boolean" class="headerlink" title="Boolean"></a>Boolean</h4><p>Boolean 类型是ECMAScript 中使用得最多的一种类型，该类型只有两个字面值：<code>true</code> 和 <code>false</code>。同样也需要区分基本的 Boolean 类型以及 Boolean 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isBoolean</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> </span><br><span class="line">    value === <span class="literal">true</span> || value === <span class="literal">false</span> ||</span><br><span class="line">    (isObjectLike(value) </span><br><span class="line">     &amp;&amp; getTag(value) == <span class="string">'[object Boolean]'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大部分在之前都已经涉及到了，这里出现了 <code>isObjectLike</code>，那么它是做什么的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isObjectLike</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> value == <span class="string">'object'</span> &amp;&amp; value !== <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原来只是检测是否是一个非 <code>null</code>  的对象。</p>
<h4 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h4><p>ES6 引入了一种新的原始数据类型<code>Symbol</code>，表示独一无二的值。Symbol 值通过<code>Symbol</code>函数生成。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isSymbol</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> type = <span class="keyword">typeof</span> value</span><br><span class="line">  <span class="keyword">return</span> type == <span class="string">'symbol'</span> || </span><br><span class="line">      (isObjectLike(value) &amp;&amp; </span><br><span class="line">       getTag(value) == <span class="string">'[object Symbol]'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会发现 <code>(isObjectLike(value) &amp;&amp; getTag(value) == &#39;[object Symbol]&#39;)</code>，也对 Symbol 对象进行检测，但是如果直接 <code>new Symbol</code> 会 log 出 <code>TypeError</code>。</p>
<p>那么 <strong>lodash</strong> 为什么要对其进行检测，原来是创建一个显式包装器对象从 ECMAScript 6 开始不再被支持，现在可以利用如下代码来模拟，虽然没什么用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sym = <span class="built_in">Symbol</span>(<span class="string">"foo"</span>);</span><br><span class="line"><span class="keyword">typeof</span> sym;     <span class="comment">// "symbol"</span></span><br><span class="line"><span class="keyword">const</span> symObj = <span class="built_in">Object</span>(sym);</span><br><span class="line"><span class="keyword">typeof</span> symObj;  <span class="comment">// "object"</span></span><br></pre></td></tr></table></figure>

<h4 id="Undefined"><a href="#Undefined" class="headerlink" title="Undefined"></a>Undefined</h4><p>Undefined 类型只有一个值，即特殊的 <code>undefined</code>。在使用 <code>let</code> 或 <code>var</code> 声明变量但未对其加以初始化时，这个变量的值就是 <code>undefined</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isUndefined</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value === <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Null"><a href="#Null" class="headerlink" title="Null"></a>Null</h4><p>Null 类型是只有一个值的数据类型，这个特殊的值是 <code>null</code> 。与 <code>undefined</code> 不同的是，它是一个字面量，而 <code>undefined</code> 是全局对象的一个属性。</p>
<p>从逻辑角度来看，null 值表示一个空对象指针，<code>null</code> 是表示缺少的标识，指示变量未指向任何对象。而这也正是使用typeof 操作符检测null 值时会返回”object”的原因。</p>
<p>对其的判断也非常的简单，只需要</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isNull</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> value === <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然你也可以使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.prototype.toString.call(<span class="literal">null</span>))</span><br><span class="line"><span class="comment">// [object Null]</span></span><br></pre></td></tr></table></figure>

<p>以上是基本数据类型的判断，总结一下，主要是利用 <code>typeOf</code> 以及 <code>Object.prototype.toString</code> ，还有一些特殊值的特性。下面开始分析引用类型 <code>Object</code></p>
<h3 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h3><p>引用类型的值（对象）是引用类型的一个实例。在ECMAScript 中，引用类型是一种数据结构，用于将数据和功能组织在一起。具体的有 <code>Object</code> 、<code>Array</code>、<code>Date</code>、<code>Error</code>、<code>RegExp</code>、<code>Function</code>，还有ES2015 引入 <code>Set</code>、<code>Map</code>、<code>WeakSet</code>、<code>WeakMap</code>。</p>
<h4 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h4><p>ECMAScript 中的对象其实就是一组数据和功能的集合。它有一个很重要的用途，就是在 JavaScript 中的所有对象都来自 <code>Object</code>；所有对象从<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/prototype" target="_blank" rel="noopener"><code>Object.prototype</code></a>继承方法和属性，尽管它们可能被覆盖。即在ECMAScript 中，Object 类型是所有它的实例的基础。</p>
<p>所以 <strong>Lodash</strong> 去判断 <code>value</code> 是否为 <code>Object</code> 时，只使用了 <code>typeOf</code> 操作即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isObject</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> type = <span class="keyword">typeof</span> value</span><br><span class="line">  <span class="keyword">return</span> value != <span class="literal">null</span> &amp;&amp; </span><br><span class="line">      (type == <span class="string">'object'</span> || type == <span class="string">'function'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h4><p><strong>Function 构造函数</strong> 创建一个新的Function对象。 在 JavaScript 中, 每个函数实际上都是一个<code>Function对象。</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isFunction</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> tag = getTag(value)</span><br><span class="line">  <span class="keyword">return</span> tag == <span class="string">'[object Function]'</span> || </span><br><span class="line">      	tag == <span class="string">'[object AsyncFunction]'</span> ||</span><br><span class="line">    	tag == <span class="string">'[object GeneratorFunction]'</span> || </span><br><span class="line">      	tag == <span class="string">'[object Proxy]'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有个问题，<code>typeOf</code> 可以检测 Function对象的类型为 <code>Function</code>， 那为什么还需要 <code>Object.prototype.toString</code> 呢？</p>
<blockquote>
<p><em>// in Safari 9 which returns ‘object’ for typed arrays and other constructors.</em></p>
</blockquote>
<h4 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h4><p>Array 在 ECMAScript 中代表数组，它的每一项可以保存任何类型的数据。</p>
<p>对它的常规检测就是 <code>Array.isArray</code>，<strong>Lodash</strong> 也是使用这个 API，如果需要 Polyfill 方案的话，可以使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// plan 1</span></span><br><span class="line"><span class="built_in">Object</span>.prototype.toString.call(value) === <span class="string">'[object Array]'</span></span><br><span class="line"><span class="comment">// plan 2</span></span><br><span class="line">value.constructor === <span class="built_in">Array</span></span><br></pre></td></tr></table></figure>

<p>之前还有 <code>value instanceof Array</code> 会什么问题么？</p>
<blockquote>
<p>在存在不同全局变量的环境，通过语义 <code>instanceof</code> 检测数组的时候，<code>value instanceof Array</code>只有当 <code>value</code> 是由该页面的原始 <code>Array</code> 构造函数创建的数组时才能正常工作。</p>
<p>具体请见，<a href="http://web.mit.edu/jwalden/www/isArray.html。" target="_blank" rel="noopener">http://web.mit.edu/jwalden/www/isArray.html。</a></p>
</blockquote>
<h4 id="Date"><a href="#Date" class="headerlink" title="Date"></a>Date</h4><p>ECMAScript 中的 Date 类型是在早期Java 中的java.util.Date 类基础上构建的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nodeIsDate = nodeTypes &amp;&amp; nodeTypes.isDate</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isDate = nodeIsDate</span><br><span class="line">  ? <span class="function">(<span class="params">value</span>) =&gt;</span> nodeIsDate(value)</span><br><span class="line">  : <span class="function">(<span class="params">value</span>) =&gt;</span> isObjectLike(value) &amp;&amp; getTag(value) == <span class="string">'[object Date]'</span></span><br></pre></td></tr></table></figure>

<p><strong>Lodash</strong> 分为两个环境来处理这个问题，如果是 Node 就利用 <code>util.types.isDate(value)</code> 来检测，如果是在游览器，就还是通过 <code>Object.prototype.toString</code> 来判断。</p>
<h4 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h4><p>ES2015 提供了新的数据结构 Set。它类似于数组，但是成员的值都是唯一的，没有重复的值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isSet = nodeIsSet</span><br><span class="line">  ? <span class="function">(<span class="params">value</span>) =&gt;</span> nodeIsSet(value)</span><br><span class="line">  : <span class="function">(<span class="params">value</span>) =&gt;</span> isObjectLike(value) &amp;&amp; getTag(value) == <span class="string">'[object Set]'</span></span><br></pre></td></tr></table></figure>

<p>同样的还有 <code>Map</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isMap = nodeIsMap</span><br><span class="line">  ? <span class="function">(<span class="params">value</span>) =&gt;</span> nodeIsMap(value)</span><br><span class="line">  : <span class="function">(<span class="params">value</span>) =&gt;</span> isObjectLike(value) &amp;&amp; getTag(value) == <span class="string">'[object Map]'</span></span><br></pre></td></tr></table></figure>

<h4 id="WeakSet"><a href="#WeakSet" class="headerlink" title="WeakSet"></a>WeakSet</h4><p>WeakSet 结构与 Set 类似，也是不重复的值的集合。但是，它与 Set 有两个区别。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isWeakSet</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isObjectLike(value) &amp;&amp; getTag(value) == <span class="string">'[object WeakSet]'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也是利用 <code>Object.prototype.toString</code> ，同样还有 <code>WeakMap</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isWeakMap</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isObjectLike(value) &amp;&amp; getTag(value) == <span class="string">'[object WeakMap]'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h4><p>当运行时错误产生时，Error的实例对象会被抛出。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isError</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObjectLike(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">const</span> tag = getTag(value)</span><br><span class="line">  <span class="keyword">return</span> tag == <span class="string">'[object Error]'</span> || </span><br><span class="line">      tag == <span class="string">'[object DOMException]'</span> ||</span><br><span class="line">    (<span class="keyword">typeof</span> value.message == <span class="string">'string'</span> &amp;&amp; <span class="keyword">typeof</span> value.name == <span class="string">'string'</span> &amp;&amp; !isPlainObject(value))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有之前一致的 <code>Object.prototype.toString</code> 依然可以用来判断对象是否是一个 Error，除此之外，如果对象满足以下条件，也可以被视为一个 Error</p>
<ul>
<li>具备 <code>message</code>、<code>name</code> 属性，且值为 <code>string</code>；</li>
<li>是普通对象。 也就是说该对象由 <code>Object</code> 构造函数创建，或者 <code>[[Prototype]]</code> 为 <code>null</code> 。</li>
</ul>
<p>那么如何检测普通对象呢?</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPlainObject</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObjectLike(value) || getTag(value) != <span class="string">'[object Object]'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Object</span>.getPrototypeOf(value) === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> proto = value</span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">Object</span>.getPrototypeOf(proto) !== <span class="literal">null</span>) &#123;</span><br><span class="line">    proto = <span class="built_in">Object</span>.getPrototypeOf(proto)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.getPrototypeOf(value) === proto</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是利用 <code>Object.getPrototypeOf()</code> 方法返回指定对象的原型（内部<code>[[Prototype]]</code>属性的值），同时和 <code>value</code> 本身的 <code>[[Prototype]]</code> 做判断。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/19/vue-dynamic-components/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yzz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yzz的神秘商店💪">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/19/vue-dynamic-components/" class="post-title-link" itemprop="url">Vue 动态组件 & 异步组件原理</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-19 14:21:29" itemprop="dateCreated datePublished" datetime="2019-07-19T14:21:29+08:00">2019-07-19</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-25 16:27:34" itemprop="dateModified" datetime="2019-07-25T16:27:34+08:00">2019-07-25</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>动态组件 &amp; 异步组件的存在，使得我们更方便地控制首屏代码的体积，加快加载速度。</p>
</blockquote>
<p>抛开具体细节不谈，一个普通 Vue 组件从创建到展现在页面里，主要经历了以下流程：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 组件 Object</span></span><br><span class="line">&#123;</span><br><span class="line">    template: <span class="string">'&lt;div&gt;I am async!&lt;/div&gt;'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 经过 compileToFunctions 得到对应的 render function </span></span><br><span class="line"><span class="keyword">with</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> _c(<span class="string">'div'</span>, [_v(<span class="string">"I am async!"</span>)])</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在经过 render 得到 Vnode 再 update 成为真实DOM</span></span><br></pre></td></tr></table></figure>

<p>动态组件&amp;异步组件与之有什么区别呢？</p>
<p>主要区别在于 <code>render</code> 中 <code>createComponent</code> 这一步，举例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 组件</span></span><br><span class="line">Vue.component(<span class="string">'example'</span>, &#123;</span><br><span class="line">    template: <span class="string">'&lt;div&gt;I am async!&lt;/div&gt;'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>普通组件在 <code>createComponent</code> 时，会依据开发者自定义的 <code>options</code>，利用 <code>Vue.extend</code> 生成对应的构造函数，从而得到对应的 <code>Vnode</code> 。而一个异步组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 异步组件</span></span><br><span class="line">Vue.component(<span class="string">'async-example'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 利用 setTimeout 模拟请求</span></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 向 `resolve` 回调传递组件定义</span></span><br><span class="line">        resolve(&#123;</span><br><span class="line">            template: <span class="string">'&lt;div&gt;I am async!&lt;/div&gt;'</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>则是要经过一系列处理，具体过程如下</p>
<blockquote>
<p>在源码的 <a href="https://github.com/vuejs/vue/blob/dev/src/core/vdom/create-component.js" target="_blank" rel="noopener">create-component</a>。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async component</span></span><br><span class="line"><span class="keyword">let</span> asyncFactory</span><br><span class="line"><span class="keyword">if</span> (isUndef(Ctor.cid)) &#123;</span><br><span class="line">    asyncFactory = Ctor</span><br><span class="line">    Ctor = resolveAsyncComponent(asyncFactory, baseCtor, context)</span><br><span class="line">    <span class="keyword">if</span> (Ctor === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="comment">// return a placeholder node for async component, which is rendered</span></span><br><span class="line">        <span class="comment">// as a comment node but preserves all the raw information for the node.</span></span><br><span class="line">        <span class="comment">// the information will be used for async server-rendering and hydration.</span></span><br><span class="line">        <span class="keyword">return</span> createAsyncPlaceholder(</span><br><span class="line">            asyncFactory,</span><br><span class="line">            data,</span><br><span class="line">            context,</span><br><span class="line">            children,</span><br><span class="line">            tag</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先 <code>Ctor</code> 就与之前不同，这里为一个 <code>function</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 利用 setTimeout 模拟请求</span></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 向 `resolve` 回调传递组件定义</span></span><br><span class="line">        resolve(&#123;</span><br><span class="line">            template: <span class="string">'&lt;div&gt;I am async!&lt;/div&gt;'</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后调用 <code>resolveAsyncComponent(asyncFactory, baseCtor, context)</code></p>
<blockquote>
<p><strong>resolveAsyncComponent</strong> 在源码的 <a href="https://github.com/vuejs/vue/blob/dev/src/core/vdom/helpers/resolve-async-component.js" target="_blank" rel="noopener">resolveAsyncComponent</a>。</p>
</blockquote>
<p><code>resolveAsyncComponent</code> 的主要功能是定义 <code>Ctor</code> 所需要的 <code>resolve</code> 、<code>reject</code> 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// factory 为 Ctor</span></span><br><span class="line">factory(resolve, reject)</span><br></pre></td></tr></table></figure>

<p>以 <code>resolve</code> 函数为例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resolve = once(<span class="function">(<span class="params">res: <span class="built_in">Object</span> | Class&lt;Component&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 缓存 resolved</span></span><br><span class="line">    factory.resolved = ensureCtor(res, baseCtor)</span><br><span class="line">    <span class="comment">// 强制渲染</span></span><br><span class="line">    <span class="keyword">if</span> (!sync) &#123;</span><br><span class="line">    	forceRender(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>once</code> 字面理解，就是只调用一次。当 <code>Ctor</code> 中 <code>setTimeout</code> 结束时调用。</p>
<p><code>ensureCtor</code> 就是 <code>Vue.extend</code> 的封装以适应不同场景，所以 <code>resolve</code> 函数的主要功能就是在异步完成时，将得到的 <code>Ctor</code> 转化为构造函数，缓存在 <code>factory.resolved</code> 中。</p>
<p>之后利用 <code>forceRender(true)</code> 强制重新 render，由于之前缓存了 <code>factory.resolved</code>，<code>resolveAsyncComponent</code> 函数就直接返回了组件的构造函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isDef(factory.resolved)) &#123;</span><br><span class="line">    <span class="keyword">return</span> factory.resolved</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后就与普通组件一致了。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Yzz</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/FatGe" title="GitHub &rarr; https://github.com/FatGe" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
            </div>
          

          

          
          

          
        </div>
      </div>

      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yzz</span>

  

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  
  













  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>




  

  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  

  

  



  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  


  

</body>
</html>
